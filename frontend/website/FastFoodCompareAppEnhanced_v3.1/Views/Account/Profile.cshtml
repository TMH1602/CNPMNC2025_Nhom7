@{
    ViewData["Title"] = "Th√¥ng tin ng∆∞·ªùi d√πng";
}

<style>
    /* ... (To√†n b·ªô CSS c·ªßa b·∫°n ·ªü ƒë√¢y - kh√¥ng thay ƒë·ªïi) ... */
    .sidebar-avatar {
        width: 48px; height: 48px; border-radius: 50%;
        background-color: #ff6a00; color: #ffffff; font-weight: 600;
        font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
    }
    .profile-avatar {
        
        width: 100px;height :100px; border-radius: 50%;
        background-color: #ff6a00; color: #ffffff; font-weight: 600;
        font-size: 3rem; display: flex; align-items: center; justify-content: center;
        margin-bottom: 1rem;
    }
    .profile-sidebar .nav-link {
        color: #555; padding-top: 12px; padding-bottom: 12px;
    }
    .profile-sidebar .nav-link.active {
        color: #ff6a00; background-color: transparent;
        border-right: 3px solid #ff6a00; font-weight: 600;
    }
    .info-display-row {
        padding: 0.5rem 0;
        border-bottom: 1px dashed #eee;
    }
    .order-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
    }
    .order-card:hover {
        transform: translateY(-2px);
    }
    .order-header {
        background-color: #f8f8f8;
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .order-status-paid {
        background-color: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    .item-detail {
        padding: 10px 15px;
        border-top: 1px dashed #eee;
    }
    .card-footer {
        padding: 15px;
    }
    .footer-wrapper-white { 
        background-color: #dbcb9c; /* N·ªÅn tr·∫Øng */
        border-radius: 12px; /* Bo g√≥c */
        padding: 15px; /* Padding b√™n trong */
        bottom: 0;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* B√≥ng ƒë·ªï nh·∫π */
        text-align: left;
        width: 100%; /* ƒê·∫£m b·∫£o chi·ªÅu r·ªông ƒë·∫ßy ƒë·ªß */
        margin-top: 2rem;
    }
    #history-content {
    /* K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh */
    width: 1200px;  /* Chi·ªÅu r·ªông 100px */
    height: 1000px; /* Chi·ªÅu cao 100px */
    
    /* Cho ph√©p cu·ªôn */
    overflow: auto; /* K√≠ch ho·∫°t thanh cu·ªôn (c·∫£ ngang v√† d·ªçc) khi n·ªôi dung tr√†n */
    margin-bottom: 100px;
    }

    /* CSS B·ªî SUNG CHO L·ªäCH S·ª¨ ƒê∆†N H√ÄNG */
    /* Tr·∫°ng th√°i PAID (Gi·ªØ nguy√™n) */
    .order-status-paid {
        background-color: #d4edda; /* Xanh l√° nh·∫°t */
        color: #155724; /* Xanh l√° ƒë·∫≠m */
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    /* üéØ M√ÄU XANH CHO TR·∫†NG TH√ÅI 'DONE' */
    .order-status-done {
        background-color: #cce5ff; /* Xanh d∆∞∆°ng nh·∫°t */
        color: #004085; /* Xanh d∆∞∆°ng ƒë·∫≠m */
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    /* üéØ M√ÄU ƒê·ªé CHO C√ÅC TR·∫†NG TH√ÅI KH√ÅC (PENDING, CANCEL, v.v.) */
    .order-status-other {
        background-color: #f8d7da; /* ƒê·ªè nh·∫°t */
        color: #721c24; /* ƒê·ªè ƒë·∫≠m */
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    #content-panel {
        max-height: 75vh; /* Gi·ªõi h·∫°n chi·ªÅu cao (v√≠ d·ª•: 75% chi·ªÅu cao m√†n h√¨nh) */
        overflow-y: auto; /* Th√™m thanh cu·ªôn D·ªåC khi n·ªôi dung d√†i */
    }                       
</style>

<div id="message-panel" class="mb-3"></div>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body p-4 profile-sidebar">
                <div class="d-flex align-items-center mb-3">
                    <div class="sidebar-avatar me-3" id="sidebar-avatar-initial">...</div>
                    <div>
                        <strong id="sidebar-username" class="d-block">ƒêang t·∫£i...</strong>
                    </div>
                </div>
                <hr>
                <nav class="nav nav-pills flex-column">
                    <a class="nav-link active" href="#" data-panel="profile" id="link-profile">C·∫≠p nh·∫≠t t√†i kho·∫£n</a>
                    <a class="nav-link" href="#" data-panel="history" id="link-history">L·ªãch s·ª≠ ƒë∆°n h√†ng</a>
                </nav>
                <hr class="mt-3">
                    <div id="total-spent-summary" class="p-2 border rounded bg-light small">
                        <strong>T·ªïng chi ti√™u:</strong> <span id="total-spent-amount">...</span>
                    </div>
            </div>
        </div>
        </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-body p-4" id="content-panel">
                <div id="default-loading-content" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">ƒêang t·∫£i h·ªì s∆°...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener("DOMContentLoaded", function () {
        
        const username = localStorage.getItem("username"); 
        const token = localStorage.getItem("jwtToken"); 
        
        const LOGIN_URL = "@Url.Action("Login", "Account")";
        const API_BASE_URL = "https://localhost:7132/api/Auth";

        const encodedUsername = encodeURIComponent(username);
        
        const HISTORY_API_URL = `https://localhost:7132/api/Cart/history/${encodedUsername}`;
        const PROFILE_API_URL = `${API_BASE_URL}/account/${encodedUsername}`;

        const contentPanel = document.getElementById('content-panel');
        const messagePanel = document.getElementById("message-panel");

        if (!username || !token) {
            window.location.href = LOGIN_URL;
            return;
        }
        
        let profileData = null; 
        
        async function loadUserProfileData() {
            try {
                const response = await fetch(PROFILE_API_URL, {
                    method: "GET",
                    headers: { 
                        "accept": "application/json", 
                        "Authorization": `Bearer ${token}` 
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = LOGIN_URL;
                        return;
                    }
                    throw new Error(`L·ªói ${response.status}: ${errorText || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng.'}`);
                }
                
                profileData = await response.json();
                
            } catch (error) {
                console.error("L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:", error);
                messagePanel.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i h·ªì s∆° ng∆∞·ªùi d√πng: ${error.message}</div>`;
                profileData = { displayName: username, email: "L·ªói t·∫£i d·ªØ li·ªáu", createdDate: "" };
            }
            
            const displayName = profileData.displayName || username;
            const firstLetter = displayName.charAt(0).toUpperCase();
            document.getElementById("sidebar-avatar-initial").textContent = firstLetter;
            document.getElementById("sidebar-username").textContent = displayName;
        }

        function renderProfilePanel() {
            messagePanel.innerHTML = "";
            const data = profileData || { displayName: username, email: "...", createdDate: "" };

            const displayName = data.displayName || username;
            const firstLetter = displayName.charAt(0).toUpperCase();
            const createdDate = data.createdDate ? new Date(data.createdDate).toLocaleDateString('vi-VN') : 'N/A';
            
            contentPanel.innerHTML = `
                <h4 class="mb-4">Th√¥ng tin c√° nh√¢n</h4>
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <div class="profile-avatar mx-auto">${firstLetter}</div>
                        <p class="small text-muted">ID: ${data.userId || 'N/A'}</p>
                    </div>
                    <div class="col-md-9">
                        <div class="row info-display-row">
                            <label class="col-sm-4 col-form-label text-muted">T√™n hi·ªÉn th·ªã:</label>
                            <div class="col-sm-8 pt-2">
                                <strong id="display-name-info">${localStorage.getItem("username")}</strong>
                            </div>
                        </div>
                        <div class="row info-display-row">
                            <label class="col-sm-4 col-form-label text-muted">Email:</label>
                            <div class="col-sm-8 pt-2">
                                <strong id="email-info">${data.email || "Kh√¥ng c√≥ Email"}</strong>
                            </div>
                        </div>
                        <div class="row info-display-row">
                            <label class="col-sm-4 col-form-label text-muted">Ng√†y t·∫°o:</label>
                            <div class="col-sm-8 pt-2">
                                <span id="created-date-info">${createdDate}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <h5>Thay ƒë·ªïi m·∫≠t kh·∫©u</h5>
                <form id="change-password-form" class="mt-3">
                    <div class="mb-3 row">
                        <label for="old-password" class="col-sm-3 col-form-label">M·∫≠t kh·∫©u c≈©</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="old-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="new-password" class="col-sm-3 col-form-label">M·∫≠t kh·∫©u m·ªõi</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-gradient">L∆∞u m·∫≠t kh·∫©u m·ªõi</button>
                        </div>
                    </div>
                </form>
                
                <hr class="my-4">
                <h5 class="text-danger">X√≥a t√†i kho·∫£n</h5>
                <p class="small text-muted">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n.</p>
                <form id="delete-account-form" class="mt-3">
                    <div class="mb-3 row">
                        <label for="delete-password" class="col-sm-3 col-form-label">M·∫≠t kh·∫©u c·ªßa b·∫°n</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="delete-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-danger">X√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n</button>
                        </div>
                    </div>
                </form>
                `;
            
            attachPasswordChangeListener();
            
            // *** 3. G·ªåI H√ÄM JAVASCRIPT M·ªöI ***
            attachDeleteAccountListener();
        }

        async function renderOrderHistoryPanel() {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            messagePanel.innerHTML = "";
            contentPanel.innerHTML = `
                <h4 class="mb-4">üìú L·ªãch s·ª≠ ƒë∆°n h√†ng</h4>
                <div id="history-content" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">ƒêang t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng...</p>
                </div>
            `;
            
            updateSidebarTotalSpent(null); 

            try {
                const response = await fetch(HISTORY_API_URL, {
                    method: 'GET',
                    headers: { 
                        "accept": "application/json", 
                        "Authorization": `Bearer ${token}` 
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = LOGIN_URL;
                        return;
                    }
                    throw new Error(`L·ªói ${response.status}: ${errorText || 'Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng.'}`);
                }
                
                const orders = await response.json(); 
                
                let historyHtml = '';
                let totalSpent = 0; 

                if (!orders || orders.length === 0) {
                    historyHtml = '<div class="alert alert-info">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</div>';
                } else {
                    orders.forEach(order => {
                        const statusLower = order.status ? order.status.toLowerCase() : '';

                        if (statusLower === 'paid' || statusLower === 'done') {
                            totalSpent += order.totalAmount;
                        }
                        
                        const orderDate = new Date(order.orderDate).toLocaleString('vi-VN');
                        const totalAmount = order.totalAmount.toLocaleString('vi-VN');
                        
                        let statusClass;
                        if (statusLower === 'done') {
                            statusClass = 'order-status-done'; 
                        } else if (statusLower === 'paid') {
                            statusClass = 'order-status-paid'; 
                        } else {
                            statusClass = 'order-status-other'; 
                        }

                        let itemsHtml = order.items.map(item => `
                            <div class="item-detail row">
                                <div class="col-8 text-muted">${item.productName}</div>
                                <div class="col-4 text-end">
                                    ${item.quantity} x ${(item.priceAtTime || 0).toLocaleString('vi-VN')} VNƒê
                                </div>
                            </div>
                        `).join('');

                        historyHtml += `
                            <div class="card order-card">
                                <div class="order-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>ƒê∆°n h√†ng #${order.orderId}</strong>
                                        <div class="small text-muted">${orderDate}</div>
                                    </div>
                                    <span class="${statusClass}">${order.status || 'N/A'}</span>
                                </div>
                                <div class="card-body p-0">
                                    ${itemsHtml}
                                </div>
                                <div class="card-footer d-flex justify-content-between align-items-center">
                                    <strong>T·ªïng ti·ªÅn:</strong>
                                    <strong class="text-primary">${totalAmount} VNƒê</strong>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('history-content').innerHTML = historyHtml;
                updateSidebarTotalSpent(totalSpent); 

            } catch (error) {
                console.error("L·ªói fetch l·ªãch s·ª≠ ƒë∆°n h√†ng:", error);
                document.getElementById('history-content').innerHTML = `<div class="alert alert-danger">L·ªói khi t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng: ${error.message}</div>`;
                updateSidebarTotalSpent(0); 
            }
        }

        function updateSidebarTotalSpent(totalAmount) {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            const totalSpentEl = document.getElementById("total-spent-summary");
            const totalSpentAmountEl = document.getElementById("total-spent-amount");

            if (totalSpentEl && totalSpentAmountEl) {
                if (totalAmount !== null) {
                    totalSpentAmountEl.textContent = totalAmount.toLocaleString('vi-VN') + ' VNƒê';
                    totalSpentEl.style.display = 'block'; 
                } else {
                    totalSpentAmountEl.textContent = 'ƒêang t·∫£i...';
                    totalSpentEl.style.display = 'block'; 
                }
            }
        }

        function attachPasswordChangeListener() {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            const form = document.getElementById("change-password-form");
            if (!form) return;

            form.addEventListener("submit", async function(e) {
                e.preventDefault(); 
                
                const oldPasswordEl = document.getElementById("old-password");
                const newPasswordEl = document.getElementById("new-password");

                const oldPassword = oldPasswordEl.value;
                const newPassword = newPasswordEl.value;
                
                if (!newPassword || newPassword.length < 6) {
                    messagePanel.innerHTML = `<div class="alert alert-warning">M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!</div>`;
                    return;
                }

                const data = {
                    oldPassword: oldPassword,
                    newPassword: newPassword
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/change-password`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "accept": "application/json", 
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const responseData = await response.json(); 

                    if (response.ok && responseData.isSuccess) {
                        messagePanel.innerHTML = `<div class="alert alert-success">${responseData.message || 'ƒê√£ thay ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!'}</div>`;
                        oldPasswordEl.value = "";
                        newPasswordEl.value = "";
                    } else {
                        if (response.status === 401) {
                            messagePanel.innerHTML = `<div class="alert alert-danger">Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.</div>`;
                            localStorage.clear();
                            setTimeout(() => window.location.href = LOGIN_URL, 2000);
                            return;
                        }
                        const errorMessage = responseData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh khi ƒë·ªïi m·∫≠t kh·∫©u.';
                        messagePanel.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                    }

                } catch (error) {
                    console.error("L·ªói fetch ho·∫∑c JSON:", error);
                    messagePanel.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi ho·∫∑c API ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá.</div>`;
                }
            });
        }
        
        // *** 2. H√ÄM JAVASCRIPT M·ªöI ƒê∆Ø·ª¢C TH√äM V√ÄO ƒê√ÇY ***
        function attachDeleteAccountListener() {
            const form = document.getElementById("delete-account-form");
            if (!form) return;

            form.addEventListener("submit", async function(e) {
                e.preventDefault();
                
                // Th√™m x√°c nh·∫≠n
                if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
                    return; 
                }

                const passwordEl = document.getElementById("delete-password");
                const currentPassword = passwordEl.value;

                if (!currentPassword) {
                    messagePanel.innerHTML = `<div class="alert alert-warning">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n.</div>`;
                    return;
                }

                const data = {
                    currentPassword: currentPassword
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/delete-my-account`, {
                        method: "DELETE", // Method l√† DELETE
                        headers: { 
                            "Content-Type": "application/json",
                            "accept": "application/json", // API tr·∫£ v·ªÅ DeleteAccountResponse (JSON)
                            "Authorization": `Bearer ${token}` // B·∫Øt bu·ªôc ph·∫£i c√≥ token
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const responseData = await response.json(); 

                    if (response.ok && responseData.isSuccess) {
                        messagePanel.innerHTML = `<div class="alert alert-success">${responseData.message || 'ƒê√£ x√≥a t√†i kho·∫£n th√†nh c√¥ng. ƒêang ƒëƒÉng xu·∫•t...'}</div>`;
                        localStorage.clear();
                        setTimeout(() => {
                            window.location.href = LOGIN_URL;
                        }, 2500);

                    } else {
                        if (response.status === 401) {
                            messagePanel.innerHTML = `<div class="alert alert-danger">Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.</div>`;
                            localStorage.clear();
                            setTimeout(() => window.location.href = LOGIN_URL, 2000);
                            return;
                        }
                        // Hi·ªÉn th·ªã l·ªói (v√≠ d·ª•: "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng ch√≠nh x√°c.")
                        const errorMessage = responseData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh khi x√≥a t√†i kho·∫£n.';
                        messagePanel.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                    }

                } catch (error) {
                    console.error("L·ªói fetch ho·∫∑c JSON:", error);
                    messagePanel.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi ho·∫∑c API ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá.</div>`;
                }
            });
        }
        // *** K·∫æT TH√öC H√ÄM M·ªöI ***


        // ===========================================
        // === LOGIC CHUY·ªÇN ƒê·ªîI PANEL (Navigation) ===
        // ===========================================
        const linkProfile = document.getElementById('link-profile');
        const linkHistory = document.getElementById('link-history');
        const navLinks = [linkProfile, linkHistory];

        function setActiveLink(activeId) {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            navLinks.forEach(link => {
                if (link.id === activeId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        linkProfile.addEventListener('click', (e) => {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            e.preventDefault();
            setActiveLink('link-profile');
            renderProfilePanel();
        });

        linkHistory.addEventListener('click', (e) => {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            e.preventDefault();
            setActiveLink('link-history');
            renderOrderHistoryPanel();
        });


        // --- CH·∫†Y L·∫¶N ƒê·∫¶U ---
        loadUserProfileData().then(() => {
            renderProfilePanel();
        });

    });
</script>
}