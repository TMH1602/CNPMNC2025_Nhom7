@{
    ViewData["Title"] = "Thông tin người dùng";
}

<style>
    /* ... (CSS cho avatar và sidebar giữ nguyên) ... */
    .sidebar-avatar {
        width: 48px; height: 48px; border-radius: 50%;
        background-color: #ff6a00; color: #ffffff; font-weight: 600;
        font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
    }
    .profile-avatar {
        width: 100px; height: 100px; border-radius: 50%;
        background-color: #ff6a00; color: #ffffff; font-weight: 600;
        font-size: 3rem; display: flex; align-items: center; justify-content: center;
        margin-bottom: 1rem;
    }
    .profile-sidebar .nav-link {
        color: #555; padding-top: 12px; padding-bottom: 12px;
    }
    .profile-sidebar .nav-link.active {
        color: #ff6a00; background-color: transparent;
        border-right: 3px solid #ff6a00; font-weight: 600;
    }
</style>

<div id="message-panel" class="mb-3"></div>

<div class="row">
    <div class="col-md-3">
        <div class="profile-sidebar">
            <div class="d-flex align-items-center mb-3">
                <div class="sidebar-avatar me-3" id="sidebar-avatar-initial"></div>
                <div>
                    <strong id="sidebar-username" class="d-block">...</strong>
                </div>
            </div>
            <hr>
            <nav class="nav nav-pills flex-column">
                <a class="nav-link active" href="@Url.Action("Profile", "Account")">Cập nhật tài khoản</a>
                <a class="nav-link" href="#">Thông tin đơn hàng</a>
                <a class="nav-link" href="#">Phương thức thanh toán</a>
            </nav>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-body p-4">
                
                <h4 class="mb-4">Thông tin người dùng</h4>

                <h5>Tải ảnh đại diện</h5>
                <div class="row mt-3 align-items-center">
                    <div class="col-md-3 text-center">
                        <div class="profile-avatar" id="profile-avatar-initial"></div>
                    </div>
                    <div class="col-md-9">
                        <p class="small text-muted mb-2">Chấp nhận GIF, JPEG, PNG, BMP...</p>
                        <input type="file" class="form-control mb-2" id="avatar-file-input">
                        <button class="btn btn-primary" id="update-avatar-btn">Cập nhật</button>
                    </div>
                </div>

                <hr class="my-4">

                <h5>Thay đổi thông tin</h5>
                <form id="profile-form" class="mt-3">
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label">Tên</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="profile-name-input" value="...">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label">Giới tính</label>
                        <div class="col-sm-9">
                            <select class="form-select" id="profile-gender-select">
                                <option value="0">Không chọn</option>
                                <option value="1">Nam</option>
                                <option value="2">Nữ</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label">Email</label>
                        <div class="col-sm-9">
                            <input type="email" readonly class="form-control-plaintext" id="profile-email-input" value="...">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-gradient">Lưu thay đổi</button>
                        </div>
                    </div>
                </form>

                <hr class="my-4">
                <h5>Thay đổi mật khẩu</h5>
                <form id="change-password-form" class="mt-3">
                    <div class="mb-3 row">
                        <label for="old-password" class="col-sm-3 col-form-label">Mật khẩu cũ</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="old-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="new-password" class="col-sm-3 col-form-label">Mật khẩu mới</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-gradient">Lưu mật khẩu mới</button>
                        </div>
                    </div>
                </form>

                <hr class="my-4">

                <h5>Quản lý số điện thoại</h5>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <div id="profile-phone-number">...</div>
                        <div class="small text-success" id="profile-phone-status" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">...</svg>
                            Số điện thoại đã được xác thực
                        </div>
                    </div>
                    <button class="btn btn-outline-primary" id="update-phone-btn">Cập nhật số điện thoại</button>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener("DOMContentLoaded", function () {
        
        // --- 1. LẤY DỮ LIỆU TỪ LOCALSTORAGE ---
        const username = localStorage.getItem("username"); // Đây chính là 'identifier'
        const token = localStorage.getItem("jwtToken"); 

        if (!username || !token) {
            window.location.href = "@Url.Action("Login", "Account")";
            return;
        }

        const firstLetter = username.charAt(0).toUpperCase();

        // --- 2. ĐIỀN DỮ LIỆU VÀO GIAO DIỆN ---
        document.getElementById("sidebar-avatar-initial").textContent = firstLetter;
        document.getElementById("sidebar-username").textContent = username;
        document.getElementById("profile-avatar-initial").textContent = firstLetter;
        document.getElementById("profile-name-input").value = username;
        document.getElementById("profile-email-input").value = "minhhoangtran1602@gmail.com"; // Placeholder
        document.getElementById("profile-phone-number").textContent = "0784224079"; // Placeholder
        document.getElementById("profile-phone-status").style.display = "block";


        // --- 3. GẮN SỰ KIỆN "CHỜ" CHO CÁC NÚT ---
        
        // (Các sự kiện cho 'profile-form', 'update-avatar-btn', 'update-phone-btn' giữ nguyên)
        document.getElementById("profile-form").addEventListener("submit", function(e) { e.preventDefault(); alert("Đã nhấn Lưu thay đổi! (Sẵn sàng gọi API)"); });
        document.getElementById("update-avatar-btn").addEventListener("click", function(e) { e.preventDefault(); alert("Đã nhấn Cập nhật Avatar! (Sẵn sàng gọi API)"); });
        document.getElementById("update-phone-btn").addEventListener("click", function(e) { e.preventDefault(); alert("Đã nhấn Cập nhật SĐT! (Sẵn sàng gọi API)"); });

        // ===================================
        // === SCRIPT MỚI CHO FORM MẬT KHẨU ===
        // ===================================
        document.getElementById("change-password-form").addEventListener("submit", async function(e) {
            e.preventDefault(); // Ngăn form submit
            
            const messagePanel = document.getElementById("message-panel");
            messagePanel.innerHTML = ""; // Xóa thông báo cũ

            const oldPasswordEl = document.getElementById("old-password");
            const newPasswordEl = document.getElementById("new-password");

            // Lấy dữ liệu từ form
            const oldPassword = oldPasswordEl.value;
            const newPassword = newPasswordEl.value;
            
            // Validation
            if (!newPassword || newPassword.length < 6) {
                messagePanel.innerHTML = `<div class="alert alert-warning">Mật khẩu mới phải có ít nhất 6 ký tự!</div>`;
                return;
            }

            // Tạo đối tượng JSON khớp với cURL mới của bạn
            const data = {
                identifier: localStorage.getItem("username"), // <-- TRƯỜNG MỚI
                oldPassword: oldPassword,
                newPassword: newPassword
            };

            console.log("Đang gửi yêu cầu đổi mật khẩu...", data);

            try {
                // Bắt đầu gọi API
                const response = await fetch("https://localhost:7132/api/Auth/change-password", {
                   method: "POST",
                   headers: { 
                       "Content-Type": "application/json",
                       "accept": "text/plain" // Khớp với cURL
                   },
                   body: JSON.stringify(data)
                });

                // cURL của bạn yêu cầu 'accept: text/plain', nên chúng ta dùng .text()
                const responseText = await response.text(); 

                if (response.ok) {
                    // Thành công
                    messagePanel.innerHTML = `<div class="alert alert-success">${responseText || 'Đổi mật khẩu thành công!'}</div>`;
                    
                    // Xóa trắng các ô mật khẩu
                    oldPasswordEl.value = "";
                    newPasswordEl.value = "";
                } else {
                    // Thất bại (ví dụ: Mật khẩu cũ sai)
                    messagePanel.innerHTML = `<div class="alert alert-danger">${responseText || 'Đổi mật khẩu thất bại.'}</div>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                messagePanel.innerHTML = `<div class="alert alert-danger">Lỗi kết nối khi đổi mật khẩu.</div>`;
            }
        });
    });
</script>
}