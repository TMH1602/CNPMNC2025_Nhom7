@{
    ViewData["Title"] = "Th√¥ng tin ng∆∞·ªùi d√πng";
}

<style>
    /* CSS cho Sidebar v√† Avatar */
    .sidebar-avatar {
        width: 48px; height: 48px; border-radius: 50%;
        background-color: #ff6a00; color: #ffffff; font-weight: 600;
        font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
    }
    .profile-avatar {
        width: 100px; height: 100px; border-radius: 50%;
        background-color: #ff6a00; color: #ffffff; font-weight: 600;
        font-size: 3rem; display: flex; align-items: center; justify-content: center;
        margin-bottom: 1rem;
    }
    .profile-sidebar .nav-link {
        color: #555; padding-top: 12px; padding-bottom: 12px;
    }
    .profile-sidebar .nav-link.active {
        color: #ff6a00; background-color: transparent;
        border-right: 3px solid #ff6a00; font-weight: 600;
    }
    /* CSS cho ph·∫ßn ch·ªâ hi·ªÉn th·ªã th√¥ng tin (Profile) */
    .info-display-row {
        padding: 0.5rem 0;
        border-bottom: 1px dashed #eee;
    }
    /* CSS B·ªî SUNG CHO L·ªäCH S·ª¨ ƒê∆†N H√ÄNG */
    .order-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
    }
    .order-card:hover {
        transform: translateY(-2px);
    }
    .order-header {
        background-color: #f8f8f8;
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .order-status-paid {
        background-color: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    .item-detail {
        padding: 10px 15px;
        border-top: 1px dashed #eee;
    }
    .card-footer {
        padding: 15px;
    }
</style>

<div id="message-panel" class="mb-3"></div>

<div class="row">
    <div class="col-md-3">
        <div class="profile-sidebar">
            <div class="d-flex align-items-center mb-3">
                <div class="sidebar-avatar me-3" id="sidebar-avatar-initial">...</div>
                <div>
                    <strong id="sidebar-username" class="d-block">ƒêang t·∫£i...</strong>
                </div>
            </div>
            <hr>
            <nav class="nav nav-pills flex-column">
                <a class="nav-link active" href="#" data-panel="profile" id="link-profile">C·∫≠p nh·∫≠t t√†i kho·∫£n</a>
                <a class="nav-link" href="#" data-panel="history" id="link-history">L·ªãch s·ª≠ ƒë∆°n h√†ng</a>
            </nav>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-body p-4" id="content-panel">
                <div id="default-loading-content" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">ƒêang t·∫£i h·ªì s∆°...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener("DOMContentLoaded", function () {
        
        const username = localStorage.getItem("username"); 
        const token = localStorage.getItem("jwtToken"); 
        const LOGIN_URL = "@Url.Action("Login", "Account")";
        const API_BASE_URL = "https://localhost:7132/api/Auth";
        const HISTORY_API_URL = `https://localhost:7132/api/Cart/history/${username}`;
        const PROFILE_API_URL = `${API_BASE_URL}/account/${username}`;

        const contentPanel = document.getElementById('content-panel');
        const messagePanel = document.getElementById("message-panel");

        if (!username || !token) {
            window.location.href = LOGIN_URL;
            return;
        }
        
        // --- BI·∫æN L∆ØU D·ªÆ LI·ªÜU PROFILE ---
        let profileData = null; 
        
        // --- H√ÄM T·∫¢I D·ªÆ LI·ªÜU USER T·ª™ API ---
        async function loadUserProfileData() {
            try {
                const response = await fetch(PROFILE_API_URL, {
                    method: "GET",
                    headers: { "accept": "text/plain" }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`L·ªói ${response.status}: ${errorText || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng.'}`);
                }
                
                profileData = await response.json();
                
            } catch (error) {
                console.error("L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:", error);
                messagePanel.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i h·ªì s∆° ng∆∞·ªùi d√πng: ${error.message}</div>`;
                profileData = { displayName: username, email: "L·ªói t·∫£i d·ªØ li·ªáu", createdDate: "" };
            }
            
            // C·∫≠p nh·∫≠t Sidebar sau khi t·∫£i
            const displayName = profileData.displayName || username;
            const firstLetter = displayName.charAt(0).toUpperCase();
            document.getElementById("sidebar-avatar-initial").textContent = firstLetter;
            document.getElementById("sidebar-username").textContent = displayName;
        }

        // ===========================================
        // === H√ÄM RENDER N·ªòI DUNG PROFILE (C·∫≠p nh·∫≠t t√†i kho·∫£n) ===
        // ===========================================
        function renderProfilePanel() {
            messagePanel.innerHTML = "";
            const data = profileData || { displayName: username, email: "...", createdDate: "" };

            const displayName = data.displayName || username;
            const firstLetter = displayName.charAt(0).toUpperCase();
            const createdDate = data.createdDate ? new Date(data.createdDate).toLocaleDateString('vi-VN') : 'N/A';
            
            contentPanel.innerHTML = `
                <h4 class="mb-4">Th√¥ng tin c√° nh√¢n</h4>

                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <div class="profile-avatar mx-auto">${firstLetter}</div>
                        <p class="small text-muted">ID: ${data.userId || 'N/A'}</p>
                    </div>
                    <div class="col-md-9">
                        
                        <div class="row info-display-row">
                            <label class="col-sm-4 col-form-label text-muted">T√™n hi·ªÉn th·ªã:</label>
                            <div class="col-sm-8 pt-2">
                                <strong id="display-name-info">${displayName}</strong>
                            </div>
                        </div>
                        <div class="row info-display-row">
                            <label class="col-sm-4 col-form-label text-muted">Email:</label>
                            <div class="col-sm-8 pt-2">
                                <strong id="email-info">${data.email || "Kh√¥ng c√≥ Email"}</strong>
                            </div>
                        </div>
                        <div class="row info-display-row">
                            <label class="col-sm-4 col-form-label text-muted">Ng√†y t·∫°o:</label>
                            <div class="col-sm-8 pt-2">
                                <span id="created-date-info">${createdDate}</span>
                            </div>
                        </div>

                    </div>
                </div>
                
                <hr class="my-4">

                <h5>Thay ƒë·ªïi m·∫≠t kh·∫©u</h5>
                <form id="change-password-form" class="mt-3">
                    <div class="mb-3 row">
                        <label for="old-password" class="col-sm-3 col-form-label">M·∫≠t kh·∫©u c≈©</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="old-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="new-password" class="col-sm-3 col-form-label">M·∫≠t kh·∫©u m·ªõi</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-gradient">L∆∞u m·∫≠t kh·∫©u m·ªõi</button>
                        </div>
                    </div>
                </form>
            `;
            // G·∫Øn l·∫°i listener cho form ƒë·ªïi m·∫≠t kh·∫©u
            attachPasswordChangeListener();
        }

        // ===============================================
        // === H√ÄM T·∫¢I & RENDER L·ªäCH S·ª¨ ƒê∆†N H√ÄNG ===
        // ===============================================
        async function renderOrderHistoryPanel() {
            messagePanel.innerHTML = "";
            contentPanel.innerHTML = `
                <h4 class="mb-4">üìú L·ªãch s·ª≠ ƒë∆°n h√†ng</h4>
                <div id="history-content" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">ƒêang t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng...</p>
                </div>
            `;
            
            try {
                const response = await fetch(HISTORY_API_URL, {
                    method: 'GET',
                    headers: { 'accept': 'text/plain' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`L·ªói ${response.status}: ${errorText || 'Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng.'}`);
                }
                
                const orders = await response.json(); 
                
                let historyHtml = '';

                if (!orders || orders.length === 0) {
                    historyHtml = '<div class="alert alert-info">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</div>';
                } else {
                    orders.forEach(order => {
                        const orderDate = new Date(order.orderDate).toLocaleString('vi-VN');
                        const totalAmount = order.totalAmount.toLocaleString('vi-VN');
                        const statusClass = order.status && order.status.toLowerCase() === 'paid' ? 'order-status-paid' : 'bg-secondary text-white p-1 rounded';

                        let itemsHtml = order.items.map(item => `
                            <div class="item-detail row">
                                <div class="col-8 text-muted">${item.productName}</div>
                                <div class="col-4 text-end">
                                    ${item.quantity} x ${(item.priceAtTime || 0).toLocaleString('vi-VN')} VNƒê
                                </div>
                            </div>
                        `).join('');

                        historyHtml += `
                            <div class="card order-card">
                                <div class="order-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>ƒê∆°n h√†ng #${order.orderId}</strong>
                                        <div class="small text-muted">${orderDate}</div>
                                    </div>
                                    <span class="${statusClass}">${order.status || 'N/A'}</span>
                                </div>
                                <div class="card-body p-0">
                                    ${itemsHtml}
                                </div>
                                <div class="card-footer d-flex justify-content-between align-items-center">
                                    <strong>T·ªïng ti·ªÅn:</strong>
                                    <strong class="text-primary">${totalAmount} VNƒê</strong>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('history-content').innerHTML = historyHtml;

            } catch (error) {
                console.error("L·ªói fetch l·ªãch s·ª≠ ƒë∆°n h√†ng:", error);
                document.getElementById('history-content').innerHTML = `<div class="alert alert-danger">L·ªói khi t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng: ${error.message}</div>`;
            }
        }

        // ============================================
        // === H√ÄM G·∫ÆN L·∫ÆNG NGHE S·ª∞ KI·ªÜN ƒê·ªîI M·∫¨T KH·∫®U ===
        // ============================================
        function attachPasswordChangeListener() {
            const form = document.getElementById("change-password-form");
            if (!form) return;

            form.addEventListener("submit", async function(e) {
                e.preventDefault(); 
                
                const oldPasswordEl = document.getElementById("old-password");
                const newPasswordEl = document.getElementById("new-password");

                const oldPassword = oldPasswordEl.value;
                const newPassword = newPasswordEl.value;
                
                if (!newPassword || newPassword.length < 6) {
                    messagePanel.innerHTML = `<div class="alert alert-warning">M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!</div>`;
                    return;
                }

                const data = {
                    identifier: username, 
                    oldPassword: oldPassword,
                    newPassword: newPassword
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/change-password`, {
                       method: "POST",
                       headers: { 
                            "Content-Type": "application/json",
                            "accept": "application/json" 
                       },
                       body: JSON.stringify(data)
                    });
                    
                    const responseData = await response.json(); 

                    if (response.ok && responseData.isSuccess) {
                        messagePanel.innerHTML = `<div class="alert alert-success">ƒê√£ thay ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!</div>`;
                        oldPasswordEl.value = "";
                        newPasswordEl.value = "";
                    } else {
                        const errorMessage = responseData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh khi ƒë·ªïi m·∫≠t kh·∫©u.';
                        messagePanel.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                    }

                } catch (error) {
                    console.error("L·ªói fetch ho·∫∑c JSON:", error);
                    messagePanel.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi ho·∫∑c API ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá.</div>`;
                }
            });
        }
        
        // ===========================================
        // === LOGIC CHUY·ªÇN ƒê·ªîI PANEL (Navigation) ===
        // ===========================================
        const linkProfile = document.getElementById('link-profile');
        const linkHistory = document.getElementById('link-history');
        const navLinks = [linkProfile, linkHistory];

        function setActiveLink(activeId) {
            navLinks.forEach(link => {
                if (link.id === activeId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        linkProfile.addEventListener('click', (e) => {
            e.preventDefault();
            setActiveLink('link-profile');
            renderProfilePanel();
        });

        linkHistory.addEventListener('click', (e) => {
            e.preventDefault();
            setActiveLink('link-history');
            renderOrderHistoryPanel();
        });


        // --- CH·∫†Y L·∫¶N ƒê·∫¶U ---
        // 1. T·∫£i d·ªØ li·ªáu h·ªì s∆°
        loadUserProfileData().then(() => {
            // 2. M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã panel profile
            renderProfilePanel();
        });

    });
</script>
}