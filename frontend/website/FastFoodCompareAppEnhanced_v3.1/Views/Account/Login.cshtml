@{
    ViewData["Title"] = "Đăng nhập";
}

<div class="auth-card">
    <div class="auth-hero">
        <h2>Chào mừng trở lại</h2>
    </div>

    <div id="message-panel"></div>

    <form id="login-form">
        <div class="mb-3">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" class="form-control" name="username" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <input type="password" class="form-control" name="password" required />
        </div>
        <button type="submit" class="btn btn-gradient w-100">Đăng nhập</button>
    </form>

    <div class="mt-3 text-center">
        <span>Bạn chưa có tài khoản? <a href="@Url.Action("Register","Account")" class="signup-link">Đăng ký</a></span>
    </div>
    <div class="mt-3 text-center">
        <span>Bạn cần đăng nhập Với tư cách nhà hàng? <a href="@Url.Action("Restaurant","Account")" class="signup-link">Đăng nhập với tư cách nhà hàng</a></span>
    </div>
</div>

@section Scripts {
<script>
    // *** SỬA LỖI NÚT "BACK" (BFCACHE) ***
    // Sự kiện này chạy mỗi khi trang được hiển thị, bao gồm cả khi nhấn nút "Back"
    window.addEventListener('pageshow', function(event) {
        // 'event.persisted' = true có nghĩa là trang được tải từ cache (do nhấn "Back")
        if (event.persisted) {
            // Xóa thông báo cũ ngay lập tức
            document.getElementById("message-panel").innerHTML = "";
            
            // Xóa luôn token cũ nếu người dùng bị "kẹt" ở trang login
            localStorage.clear(); 
        }
    });

    // Dọn dẹp thông báo khi trang tải lần đầu (vẫn giữ lại)
    document.getElementById("message-panel").innerHTML = "";
    // *** KẾT THÚC SỬA LỖI ***


    /**
     * Hàm helper để "ĐỌC" token (Giải mã JWT Payload)
     */
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("Lỗi khi giải mã token:", e);
            return null;
        }
    }


    document.getElementById("login-form").addEventListener("submit", async function (event) {
        
        event.preventDefault();

        const form = event.target;
        const messagePanel = document.getElementById("message-panel");
        messagePanel.innerHTML = ""; 

        // Xóa token cũ trước khi đăng nhập mới
        localStorage.clear(); 

        const username = form.elements.username.value;
        const password = form.elements.password.value;

        const data = {
            username: username,
            password: password
        };

        try {
            const response = await fetch("https://localhost:7132/api/Auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "accept": "application/json" 
                },
                body: JSON.stringify(data)
            });


            if (response.ok) {
                // 5. XỬ LÝ KHI THÀNH CÔNG
                const responseData = await response.json(); 
                
                localStorage.setItem("jwtToken", responseData.token);
                localStorage.setItem("username", username);

                // LOGIC PHÂN QUYỀN
                let userRole = "";
                let redirectUrl = "";
                
                try {
                    const decodedToken = parseJwt(responseData.token);
                    userRole = decodedToken["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
                    console.log("Đã giải mã vai trò:", userRole);

                } catch (e) {
                    console.error("Không thể giải mã token hoặc đọc vai trò:", e);
                    messagePanel.innerHTML = `<div class="alert alert-danger">Lỗi đọc thông tin token.</div>`;
                    return;
                }

                // Quyết định chuyển hướng
                switch (userRole) {
                    case "Quản Trị Viên":
                        redirectUrl = "@Url.Page("/Products/Index", new { area = "Admin" })";
                        break;
                    case "Nhà hàng":
                        redirectUrl = "@Url.Page("/Restaurant/Kitchen", new { area = "Restaurant" })";
                        break;
                    case "Khách Hàng":
                    case "Khách Hàng Thử Nghiệm":
                        redirectUrl = "@Url.Action("Index", "Menu")";
                        break;
                    default:
                        console.warn(`Không nhận diện được vai trò: ${userRole}. Chuyển về Menu.`);
                        redirectUrl = "@Url.Action("Index", "Menu")";
                }

                messagePanel.innerHTML = `<div class="alert alert-success">Đăng nhập thành công! Đang chuyển hướng...</div>`;
                
                setTimeout(() => {
                    window.location.href = redirectUrl; 
                }, 1500);

            } else {
                // 6. XỬ LÝ KHI THẤT BẠI
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    messagePanel.innerHTML = `<div class="alert alert-danger">${errorData.message || 'Tên đăng nhập hoặc mật khẩu không đúng.'}</div>`;
                } catch (jsonError) {
                    messagePanel.innerHTML = `<div class="alert alert-danger">${errorText || 'Lỗi không xác định từ máy chủ.'}</div>`;
                }
            }

        } catch (error) {
            console.error("Lỗi fetch:", error);
            messagePanel.innerHTML = `<div class="alert alert-danger">Không thể kết nối đến máy chủ. Vui lòng thử lại sau.</div>`;
        }
    });
</script>
}