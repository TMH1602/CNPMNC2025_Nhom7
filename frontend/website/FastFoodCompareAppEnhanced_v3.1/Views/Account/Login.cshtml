@{
    ViewData["Title"] = "Đăng nhập";
}

<div class="auth-card">
    <div class="auth-hero">
        <h2>Chào mừng trở lại</h2>
    </div>

    <div id="message-panel"></div>

    <form id="login-form">
        <div class="mb-3">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" class="form-control" name="username" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <input type="password" class="form-control" name="password" required />
        </div>
        <button type="submit" class="btn btn-gradient w-100">Đăng nhập</button>
    </form>

    <div class="mt-3 text-center">
        <span>Bạn chưa có tài khoản? <a href="@Url.Action("Register","Account")" class="signup-link">Đăng ký</a></span>
    </div>
</div>

@section Scripts {
<script>
    // Bắt sự kiện khi form được submit
    document.getElementById("login-form").addEventListener("submit", async function (event) {
        
        // 1. Ngăn form submit theo cách truyền thống (tải lại trang)
        event.preventDefault();

        const form = event.target;
        const messagePanel = document.getElementById("message-panel");
        messagePanel.innerHTML = ""; // Xóa thông báo lỗi cũ

        // 2. Lấy dữ liệu từ các ô input
        const username = form.elements.username.value;
        const password = form.elements.password.value;

        // 3. Tạo đối tượng JSON để gửi đi (khớp với cURL)
        const data = {
            username: username,
            password: password
        };

        try {
            // 4. Gửi yêu cầu fetch đến API
            const response = await fetch("https://localhost:7132/api/Auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "accept": "text/plain"
                },
                body: JSON.stringify(data)
            });

            // Lấy nội dung phản hồi (token hoặc thông báo lỗi)
            const responseText = await response.text();

            if (response.ok) {
                // 5. XỬ LÝ KHI THÀNH CÔNG
                
                // Lưu token (từ responseText) vào localStorage
                localStorage.setItem("jwtToken", responseText);

                // Quan trọng: Lưu username vào localStorage
                // file _Layout.cshtml của bạn sẽ đọc key này
                localStorage.setItem("username", username);

                // Hiển thị thông báo và chuyển hướng
                messagePanel.innerHTML = `<div class="alert alert-success">Đăng nhập thành công! Đang chuyển hướng...</div>`;
                
                setTimeout(() => {
                    window.location.href = "@Url.Action("Index", "Menu")"; // Chuyển về trang Menu
                }, 1500);

            } else {
                // 6. XỬ LÝ KHI THẤT BẠI
                // Hiển thị lỗi mà API trả về
                messagePanel.innerHTML = `<div class="alert alert-danger">${responseText || 'Tên đăng nhập hoặc mật khẩu không đúng.'}</div>`;
            }

        } catch (error) {
            // 7. XỬ LÝ LỖI MẠNG (API không chạy, CORS, v.v.)
            console.error("Lỗi fetch:", error);
            messagePanel.innerHTML = `<div class="alert alert-danger">Không thể kết nối đến máy chủ. Vui lòng thử lại sau.</div>`;
        }
    });
</script>
}