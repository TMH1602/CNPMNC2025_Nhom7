@{
    ViewData["Title"] = "Đăng nhập";
}

<div class="auth-card">
    <div class="auth-hero">
        <h2>Chào mừng trở lại</h2>
    </div>

    <div id="message-panel"></div>

    <form id="login-form">
        <div class="mb-3">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" class="form-control" name="username" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <input type="password" class="form-control" name="password" required />
        </div>
        <button type="submit" class="btn btn-gradient w-100">Đăng nhập</button>
    </form>

    <div class="mt-3 text-center">
        <span>Bạn chưa có tài khoản? <a href="@Url.Action("Register","Account")" class="signup-link">Đăng ký</a></span>
    </div>
    <div class="mt-3 text-center">
        <span>Bạn cần đăng nhập Với tư cách nhà hàng? <a href="@Url.Action("Restaurant","Account")" class="signup-link">Đăng nhập với tư cách nhà hàng</a></span>
    </div>
</div>

@section Scripts {
<script>
    // Sửa lỗi cache khi nhấn nút "Back"
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            document.getElementById("message-panel").innerHTML = "";
            localStorage.clear(); 
            // Xóa cookie cũ nếu có
            document.cookie = "jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }
    });
    document.getElementById("message-panel").innerHTML = "";

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("Lỗi khi giải mã token:", e);
            return null;
        }
    }

    document.getElementById("login-form").addEventListener("submit", async function (event) {
        
        event.preventDefault();
        const form = event.target;
        const messagePanel = document.getElementById("message-panel");
        messagePanel.innerHTML = ""; 
        localStorage.clear(); 
        document.cookie = "jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT"; // Xóa cookie cũ

        const username = form.elements.username.value;
        const password = form.elements.password.value;
        const data = { username: username, password: password };

        try {
            const response = await fetch("https://localhost:7132/api/Auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "accept": "application/json" 
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const responseData = await response.json(); 
                
                // 1. LƯU VÀO LOCALSTORAGE (CHO JAVASCRIPT)
                localStorage.setItem("jwtToken", responseData.token);
                localStorage.setItem("username", username);

                // *** 2. SỬA LỖI 401: LƯU VÀO COOKIE (CHO SERVER) ***
                // (max-age=3600 giây = 1 giờ)
                document.cookie = `jwtToken=${responseData.token}; path=/; secure; samesite=strict; max-age=3600`; 

                let userRole = "";
                let redirectUrl = "";
                
                try {
                    const decodedToken = parseJwt(responseData.token);
                    userRole = decodedToken["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
                } catch (e) { /*...*/ }

                switch (userRole) {
                    case "Admin": 
                        redirectUrl = "@Url.Page("/Products/Index", new { area = "Admin" })";
                        break;
                    case "Nhà hàng":
                        redirectUrl = "@Url.Page("/Restaurant/Kitchen", new { area = "Restaurant" })";
                        break;
                    default:
                        redirectUrl = "@Url.Action("Index", "Menu")";
                }

                messagePanel.innerHTML = `<div class="alert alert-success">Đăng nhập thành công! Đang chuyển hướng...</div>`;
                
                setTimeout(() => {
                    window.location.href = redirectUrl; 
                }, 1500);

            } else {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    messagePanel.innerHTML = `<div class="alert alert-danger">${errorData.message || 'Tên đăng nhập hoặc mật khẩu không đúng.'}</div>`;
                } catch (jsonError) {
                    messagePanel.innerHTML = `<div class="alert alert-danger">${errorText || 'Lỗi không xác định từ máy chủ.'}</div>`;
                }
            }

        } catch (error) {
            console.error("Lỗi fetch:", error);
            messagePanel.innerHTML = `<div class="alert alert-danger">Không thể kết nối đến máy chủ. Vui lòng thử lại sau.</div>`;
        }
    });
</script>
}