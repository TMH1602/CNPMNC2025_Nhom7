@{
    ViewData["Title"] = "Thá»±c Ä‘Æ¡n";
}

<h2 class="mb-3">Thá»±c Ä‘Æ¡n - MÃ³n Äƒn nhanh</h2>

<div class="mb-3">
    <img src="/images/banner.jpg" onerror="this.src='/images/placeholder-ad.jpg'" class="w-100 ad-banner" alt="Ad banner" />
</div>

<div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
    <span class="me-3"><strong>GiÃ¡ trung bÃ¬nh:</strong> <span id="avgPrice">Äang tÃ­nh...</span></span>
</div>

<div id="menu-container" class="row">
    <p>Äang táº£i thá»±c Ä‘Æ¡n, vui lÃ²ng chá»...</p>
</div>

<div class="text-end mt-4">
    <button id="checkout-btn" class="btn btn-lg btn-success">ğŸ›’ Tiáº¿n hÃ nh Thanh toÃ¡n</button>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const menuContainer = document.getElementById('menu-container');
        const cartCountSpan = document.getElementById('cartCount');
        
        // =================================================================
        // HÃ€M KIá»‚M TRA USERNAME & CHUYá»‚N HÆ¯á»šNG
        // =================================================================
        function getUsername() {
            const username = localStorage.getItem('username'); // Giáº£ Ä‘á»‹nh key lÃ  'username'
            if (!username) {
                alert("Báº¡n pháº£i Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng chá»©c nÄƒng nÃ y.");
                window.location.href = 'Account/login'; 
                return null;
            }
            return username;
        }

        // =================================================================
        // CÃC HÃ€M QUáº¢N LÃ GIá» HÃ€NG Báº°NG LOCALSTORAGE
        // =================================================================
        function getCart() {
            const cartJson = localStorage.getItem('frontend_cart');
            return cartJson ? JSON.parse(cartJson) : [];
        }

        function saveCart(cart) {
            localStorage.setItem('frontend_cart', JSON.stringify(cart));
        }

        function updateCartIcon() {
            const cart = getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCountSpan) {
                cartCountSpan.innerText = totalItems;
            }
        }
        
        // =================================================================
        // HÃ€M Gá»ŒI API THANH TOÃN (Má»šI)
        // =================================================================
        async function handleCheckout() {
            const username = getUsername();
            
            if (username === null) {
                return;
            }
            
            const checkoutUrl = `https://localhost:7132/api/Cart/checkout?username=${username}`;

            try {
                // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o Ä‘ang xá»­ lÃ½
                alert("Äang tiáº¿n hÃ nh thanh toÃ¡n, vui lÃ²ng chá»...");

                const response = await fetch(checkoutUrl, {
                    method: 'POST',
                    headers: {
                        'accept': '*/*'
                    },
                    body: '' // KhÃ´ng gá»­i body theo cURL yÃªu cáº§u
                });

                if (response.ok) {
                    // API tráº£ vá» JSON khi thÃ nh cÃ´ng
                    const result = await response.json(); 
                    
                    // XÃ¢y dá»±ng thÃ´ng bÃ¡o thÃ nh cÃ´ng
                    const message = `
                        Thanh toÃ¡n thÃ nh cÃ´ng! ğŸ‰
                        MÃ£ Ä‘Æ¡n hÃ ng: ${result.orderId}
                        Tá»•ng tiá»n: ${result.totalAmount.toLocaleString('vi-VN')} VNÄ
                        Thá»i gian: ${new Date(result.orderDate).toLocaleString('vi-VN')}
                        ThÃ´ng bÃ¡o: ${result.message}
                    `;
                    alert(message);
                    
                    // TÃ¹y chá»n: XÃ³a giá» hÃ ng client-side sau khi thanh toÃ¡n thÃ nh cÃ´ng
                    // localStorage.removeItem('frontend_cart');
                    // updateCartIcon();

                    // TO DO: Chuyá»ƒn hÆ°á»›ng ngÆ°á»i dÃ¹ng Ä‘áº¿n trang xÃ¡c nháº­n/lá»‹ch sá»­ Ä‘Æ¡n hÃ ng
                    // Sau alert, báº¡n cÃ³ thá»ƒ thÃªm window.location.href = '...'
                    

                } else {
                    // Xá»­ lÃ½ lá»—i tá»« server (vÃ­ dá»¥: giá» hÃ ng trá»‘ng, lá»—i xÃ¡c thá»±c)
                    const errorText = await response.text();
                    alert(`âŒ Lá»—i Thanh ToÃ¡n: ${response.status} - ${errorText}`);
                }

            } catch (error) {
                console.error('Lá»—i káº¿t ná»‘i khi thanh toÃ¡n:', error);
                alert(`âŒ Lá»—i káº¿t ná»‘i: KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§ thanh toÃ¡n. ${error.message}`);
            }
        }

        // =================================================================
        // HÃ€M THÃŠM VÃ€O GIá» HÃ€NG (Gá»ŒI API - Giá»¯ nguyÃªn)
        // =================================================================
        async function addToCart(itemData) {
            const username = getUsername();
            
            if (username === null) {
                return;
            }
            
            const apiUrl = 'https://localhost:7132/api/Cart/add';
            
            const postData = {
                username: username,
                items: [{
                    productId: itemData.id,
                    quantity: 1
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'accept': '*/*',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lá»—i tá»« Server: ${response.status} - ${errorText}`);
                }

                const cart = getCart();
                const existingItem = cart.find(item => item.id === itemData.id);

                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({ ...itemData, quantity: 1 });
                }
                
                saveCart(cart);
                updateCartIcon();
                
                alert(`ğŸ›’ ÄÃ£ thÃªm "${itemData.name}" vÃ o giá» hÃ ng thÃ nh cÃ´ng!`);

            } catch (error) {
                console.error('Lá»—i khi thÃªm vÃ o giá» hÃ ng:', error);
                alert(`âŒ Lá»—i: KhÃ´ng thá»ƒ thÃªm "${itemData.name}" vÃ o giá» hÃ ng. ${error.message}`);
            }
        }


        // =================================================================
        // LOGIC CHÃNH Cá»¦A TRANG
        // =================================================================

        // Láº¯ng nghe sá»± kiá»‡n click Ä‘á»ƒ thÃªm vÃ o giá» hÃ ng
        document.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('add-to-cart-btn')) {
                const button = event.target;
                const itemData = {
                    id: parseInt(button.dataset.id),
                    name: button.dataset.name,
                    price: parseFloat(button.dataset.price)
                };
                addToCart(itemData);
            }
        });

        // Láº¯ng nghe sá»± kiá»‡n click cho nÃºt Thanh toÃ¡n (Má»šI)
        const checkoutButton = document.getElementById('checkout-btn');
        if(checkoutButton) {
            checkoutButton.addEventListener('click', handleCheckout);
        }

        // Táº£i danh sÃ¡ch sáº£n pháº©m tá»« API (Giá»¯ nguyÃªn)
        fetch('https://localhost:7132/api/Menu')
            .then(response => {
                if (!response.ok) throw new Error('Lá»—i káº¿t ná»‘i API.');
                return response.json();
            })
            .then(data => {
                menuContainer.innerHTML = '';
                let totalPrice = 0;
                data.forEach(item => {
                    totalPrice += item.price;
                    
                    const dishCardHtml = `
                        <div class="col-12 col-md-6 col-lg-4 mb-4">
                            <div class="dish-card">
                                <img src="${item.imageUrl}" alt="${item.name}" class="dish-image"/>
                                <div class="body">
                                    <h5>${item.name} <span class="badge bg-light text-dark badge-price">${item.price.toLocaleString('vi-VN')} VNÄ</span></h5>
                                    <p>${item.description}</p>
                                    <div class="controls mt-2">
                                        <button type="button" class="btn btn-sm btn-success add-to-cart-btn" 
                                            data-id="${item.id}" 
                                            data-name="${item.name}" 
                                            data-price="${item.price}">
                                            ğŸ›’ ThÃªm vÃ o giá»
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    menuContainer.innerHTML += dishCardHtml;
                });
                const avgPrice = data.length > 0 ? totalPrice / data.length : 0;
                document.getElementById('avgPrice').innerText = avgPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            })
            .catch(error => {
                console.error('Lá»—i khi táº£i thá»±c Ä‘Æ¡n:', error);
                menuContainer.innerHTML = '<p class="text-danger">KhÃ´ng thá»ƒ táº£i thá»±c Ä‘Æ¡n. Vui lÃ²ng kiá»ƒm tra láº¡i API.</p>';
            });

        updateCartIcon();
    });
</script>
}