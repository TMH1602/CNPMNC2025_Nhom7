@{
    ViewData["Title"] = "Th·ª±c ƒë∆°n";
}

<h2 class="mb-3">Th·ª±c ƒë∆°n - So s√°nh m√≥n ƒÉn nhanh</h2>

<div class="mb-3">
    <img src="/images/banner.jpg" onerror="this.src='/images/placeholder-ad.jpg'" class="w-100 ad-banner" alt="Ad banner" />
</div>

<div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
    <span class="me-3"><strong>Gi√° trung b√¨nh:</strong> <span id="avgPrice">ƒêang t√≠nh...</span></span>
    <span class="me-3" hidden><strong>Calories trung b√¨nh:</strong> <span id="avgCalories">...</span> kcal</span>
    <span class="me-3 badge bg-success" id="bestValue" hidden></span>
    <span class="me-3 badge bg-warning text-dark" id="topRated" hidden></span>
</div>

<form id="compareForm" method="get" action="@Url.Action("Compare","Menu")">
    <div id="menu-container" class="row compare-row">
        <p>ƒêang t·∫£i th·ª±c ƒë∆°n t·ª´ nh√† b·∫øp, vui l√≤ng ch·ªù...</p>
    </div>

    <button type="submit" class="btn btn-gradient mt-3">So s√°nh c√°c m√≥n ƒë√£ ch·ªçn</button>
</form>

@section Scripts {
<script>
    // 1. Ch·ªù trang web t·∫£i xong
    document.addEventListener('DOMContentLoaded', function () {
        const menuContainer = document.getElementById('menu-container');

        // 2. D√πng fetch ƒë·ªÉ g·ªçi "nh√† b·∫øp" (API)
        fetch('https://localhost:7132/api/Menu')
            .then(response => {
                if (!response.ok) { // N·∫øu g·ªçi th·∫•t b·∫°i (l·ªói 404, 500...)
                    throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API.');
                }
                return response.json(); // Chuy·ªÉn d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c th√†nh JSON
            })
            .then(data => { // 3. N·∫øu l·∫•y d·ªØ li·ªáu th√†nh c√¥ng
                menuContainer.innerHTML = ''; // X√≥a ch·ªØ "ƒêang t·∫£i..."
                let totalPrice = 0;

                // 4. L·∫∑p qua t·ª´ng m√≥n ƒÉn v√† t·∫°o HTML
                data.forEach(item => {
                    totalPrice += item.price;
                    
                    // T·∫°o m·ªôt kh·ªëi HTML cho m·ªói m√≥n ƒÉn
                    const dishCardHtml = `
                        <div class="col-12 col-md-6 mb-4">
                            <div class="dish-card">
                                <img src="${item.imageUrl}" alt="${item.name}" class="dish-image"/>
                                <div class="body">
                                    <h5>${item.name} <span class="badge bg-light text-dark badge-price">${item.price.toLocaleString('vi-VN')} VNƒê</span></h5>
                                    
                                    <p>${item.description}</p>
                                    <div class="controls mt-2">
                                        <input type="checkbox" name="ids" value="${item.id}" id="c${item.id}" />
                                        <label for="c${item.id}" class="mb-0"> Ch·ªçn ƒë·ªÉ so s√°nh</label>
                                        
                                        <a href="/Menu/Compare?ids=${item.id}" class="btn btn-sm btn-outline-primary ms-auto">So s√°nh ƒë∆°n</a>
                                        
                                        <form action="/Cart/Add" method="post" class="ms-2 d-inline">
                                            <input type="hidden" name="id" value="${item.id}" />
                                            <button type="submit" class="btn btn-sm btn-success">üõí Th√™m v√†o gi·ªè</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    // 5. Th√™m kh·ªëi HTML v·ª´a t·∫°o v√†o trang web
                    menuContainer.innerHTML += dishCardHtml;
                });

                // C·∫≠p nh·∫≠t gi√° trung b√¨nh
                const avgPrice = data.length > 0 ? totalPrice / data.length : 0;
                document.getElementById('avgPrice').innerText = avgPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });

            })
            .catch(error => { // N·∫øu c√≥ b·∫•t k·ª≥ l·ªói n√†o x·∫£y ra
                console.error('L·ªói khi t·∫£i th·ª±c ƒë∆°n:', error);
                menuContainer.innerHTML = '<p class="text-danger">ƒê√£ x·∫£y ra l·ªói khi t·∫£i th·ª±c ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
            });
    });

    // Gi·ªØ nguy√™n script x·ª≠ l√Ω form so s√°nh
    document.getElementById('compareForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const checks = Array.from(document.querySelectorAll('input[name="ids"]:checked'));
        if (checks.length < 2) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 2 m√≥n ƒë·ªÉ so s√°nh.');
            return;
        }
        const ids = checks.map(c => c.value).join(',');
        window.location.href = '@Url.Action("Compare", "Menu")' + '?ids=' + ids;
    });
    
</script>
}