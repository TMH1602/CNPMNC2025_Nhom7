@{
    ViewData["Title"] = "Th·ª±c ƒë∆°n";
}

<style>
    /* CSS C·ª¶A B·∫†N (Gi·ªØ nguy√™n) */
    .user-avatar {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #ff6a00;
        color: #ffffff;
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* CSS CHO BACKGROUND V√Ä C·∫§U TR√öC C·ªòT */
    body {
        background-image: url('/images/BackGround.jpg'); 
        background-size: cover;      
        background-repeat: no-repeat; 
        background-attachment: fixed; 
        background-position: center center;
    }
    .navbar {
        background-color: #fff !important; 
    }
    
    /* C·∫•u tr√∫c 2 c·ªôt */
    .container-fluid {
        padding-left: 0;
        padding-right: 0;
    }
    .page-content-wrapper {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    /* C·ªôt Tr√°i (Main Content) */
    .col-left-panel {
        background-color: rgba(255, 255, 255, 0.95);
        margin-right: 10px; /* Kho·∫£ng c√°ch 10px gi·ªØa 2 c·ªôt */
        border-radius: 12px; 
        width: 1200px;
        margin-left: 30px;
        padding: 30px;
    }
    
    /* C·ªôt Ph·∫£i (Local Cart) - FIXED BOTTOM */
    .col-right-panel {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px 12px 12px 12px; 
        padding: 20px;
        position: fixed;
        top: unset; 
        bottom: 20px;
        right: 20px; /* ƒê·∫∑t s√°t l·ªÅ ph·∫£i */
        width: 350px; /* K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh (kho·∫£ng 3-4 c·ªôt) */
        max-height: calc(250vh - 250px); /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao t·ªëi ƒëa */
        box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung qu√° d√†i */
        z-index: 1000; /* ƒê·∫£m b·∫£o n·∫±m tr√™n c√°c n·ªôi dung kh√°c */
    }

    /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ c·ªôt tr√°i ƒë·ªÉ kh√¥ng b·ªã c·ªôt ph·∫£i ƒë√® l√™n */
    .col-left-panel-wrapper {
        margin-right: 500px; 
        min-height: 250vh; 
    }

    #local-cart-items-container {
        padding-right: 5px; 
    }
    
    /* CSS cho n√∫t x√≥a item */
    .remove-item-btn {
        background: none;
        border: none;
        color: #dc3545; /* M√†u ƒë·ªè */
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0 5px;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .remove-item-btn:hover {
        opacity: 1;
        text-decoration: underline;
    }
</style>


<div class="container-fluid page-content-wrapper">
    <div class="row g-0 justify-content-between">
        
        <div class="col-left-panel col-left-panel-wrapper">
            <h2 class="mb-3">Th·ª±c ƒë∆°n - M√≥n ƒÉn nhanh</h2>
            
            <div class="mb-3">
                <img src="/images/banner.jpg" onerror="this.src='/images/placeholder-ad.jpg'" class="w-100 ad-banner" alt="Ad banner" />
            </div>

            <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
                <span class="me-3"><strong>Gi√° trung b√¨nh:</strong> <span id="avgPrice">ƒêang t√≠nh...</span></span>
            </div>

            <div id="menu-container" class="row">
                <p>ƒêang t·∫£i th·ª±c ƒë∆°n, vui l√≤ng ch·ªù...</p>
            </div>
        </div>

        <div class="col-right-panel">
            
            <h5 class="mb-3 text-center">üõí C√°c m√≥n ƒë√£ ch·ªçn <span class="badge bg-danger rounded-pill" id="local-cart-item-count">0</span></h5>

            <div id="local-cart-items-container" style="max-height: 250px; overflow-y: auto;">
                <p class="text-center text-muted">Ch∆∞a c√≥ m√≥n ƒÉn n√†o d·ª± ƒë·ªãnh th√™m v√†o gi·ªè</p>
            </div>
            
            <div id="cart-summary-total" class="mt-3 pt-3 border-top d-flex justify-content-between">
                <strong>T·ªïng c·ªông:</strong>
                <strong id="local-cart-total-amount">0 VNƒê</strong>
            </div>

            <div class="mt-3">
                <button id="clear-local-cart-btn" class="btn btn-outline-danger w-100 mb-2">
                     X√≥a Gi·ªè h√†ng T·∫°m th·ªùi
                </button>
                
                <button id="commit-cart-btn" class="btn btn-success w-100 mb-2" disabled>
                     Th√™m v√†o Gi·ªè h√†ng
                </button>
                <a href="@Url.Action("Index", "Cart")" class="btn btn-primary w-100">Xem Gi·ªè h√†ng ƒê√£ l∆∞u</a>
            </div>
        </div>
    </div>
</div>

<footer class="text-center mt-5 mb-4 text-muted">¬© 2025 FastFood Compare</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const LOCAL_CART_KEY = 'frontend_cart'; // Key cho gi·ªè h√†ng local
    const MENU_LOGIN_URL = 'Account/login'; 
    const CART_ADD_API_URL = 'https://localhost:7132/api/Cart/add';

    // =================================================================
    // H√ÄM QU·∫¢N L√ù D·ªÆ LI·ªÜU CHUNG (NAVBAR)
    // =================================================================

    window.loadCartCount = async function (user) {
        const cartCountSpan = document.getElementById("cartCount");
        if (!user || !cartCountSpan) return;

        const apiUrl = `https://localhost:7132/api/Cart/${user}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: { 'accept': 'text/plain' }
            });
            const cartData = await response.json();
            const totalItems = cartData.items ? 
                                         cartData.items.reduce((total, item) => total + (item.quantity || 0), 0) : 
                                         0;
            cartCountSpan.textContent = totalItems;
        } catch (error) {
            console.error('L·ªói t·∫£i gi·ªè h√†ng Navbar:', error);
            cartCountSpan.textContent = 0; 
        }
    }
    
    function getUsername() {
        const username = localStorage.getItem('username');
        if (!username) {
            alert("B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.");
            window.location.href = MENU_LOGIN_URL; 
            return null;
        }
        return username;
    }
    
    // =================================================================
    // H√ÄM QU·∫¢N L√ù LOCAL CART V√Ä RENDER
    // =================================================================
    const localCartItemsContainer = document.getElementById('local-cart-items-container');
    const localCartTotalAmount = document.getElementById('local-cart-total-amount');
    const commitCartBtn = document.getElementById('commit-cart-btn');
    const localCartItemCountSpan = document.getElementById('local-cart-item-count');
    const clearLocalCartBtn = document.getElementById('clear-local-cart-btn');

    function getLocalCart() {
        const cartJson = localStorage.getItem(LOCAL_CART_KEY);
        return cartJson ? JSON.parse(cartJson) : [];
    }

    function saveLocalCart(cart) {
        localStorage.setItem(LOCAL_CART_KEY, JSON.stringify(cart));
        renderLocalCartPanel(); // Lu√¥n render l·∫°i sau khi thay ƒë·ªïi
    }
    
    function clearLocalCart() {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ m√≥n ƒÉn trong gi·ªè h√†ng t·∫°m th·ªùi n√†y kh√¥ng?")) {
            localStorage.removeItem(LOCAL_CART_KEY);
            renderLocalCartPanel();
            alert("ƒê√£ x√≥a gi·ªè h√†ng t·∫°m th·ªùi.");
        }
    }
    
    // H√ÄM M·ªöI: X√≥a m·ªôt m√≥n ƒÉn c·ª• th·ªÉ kh·ªèi gi·ªè h√†ng
    function removeItemFromLocalCart(itemId) {
        const cart = getLocalCart();
        
        // T√¨m v·ªã tr√≠ c·ªßa s·∫£n ph·∫©m trong gi·ªè
        const index = cart.findIndex(item => item.id === itemId);
        
        if (index > -1) {
            if (cart[index].quantity > 1) {
                // N·∫øu s·ªë l∆∞·ª£ng > 1, gi·∫£m s·ªë l∆∞·ª£ng
                cart[index].quantity--;
                alert(`ƒê√£ gi·∫£m s·ªë l∆∞·ª£ng c·ªßa m√≥n "${cart[index].name}".`);
            } else {
                // N·∫øu s·ªë l∆∞·ª£ng = 1, x√≥a s·∫£n ph·∫©m kh·ªèi m·∫£ng
                const removedItemName = cart[index].name;
                cart.splice(index, 1);
                alert(`ƒê√£ x√≥a m√≥n "${removedItemName}" kh·ªèi gi·ªè h√†ng t·∫°m th·ªùi.`);
            }
        }
        
        saveLocalCart(cart);
    }


    function renderLocalCartPanel() {
        const items = getLocalCart();
        let totalAmount = 0;
        let totalQuantity = 0;
        let cartHtml = '<ul class="list-unstyled">';

        if (items.length === 0) {
            cartHtml = '<p class="text-center text-muted">Ch∆∞a c√≥ m√≥n ƒÉn n√†o d·ª± ƒë·ªãnh th√™m v√†o gi·ªè</p>';
            commitCartBtn.disabled = true;
            if(clearLocalCartBtn) clearLocalCartBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t x√≥a khi tr·ªëng
        } else {
            items.forEach(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                totalAmount += itemTotal;
                totalQuantity += item.quantity;
                cartHtml += `
                    <li class="d-flex justify-content-between small mb-1">
                        <span>
                            ${item.name || 'S·∫£n ph·∫©m'} (x${item.quantity})
                            <button type="button" class="remove-item-btn" data-id="${item.id}">
                                (X√≥a)
                            </button>
                        </span>
                        <span class="fw-bold">${itemTotal.toLocaleString('vi-VN')} VNƒê</span>
                    </li>
                `;
            });
            cartHtml += '</ul>';
            commitCartBtn.disabled = false;
            if(clearLocalCartBtn) clearLocalCartBtn.disabled = false; // K√≠ch ho·∫°t n√∫t x√≥a khi c√≥ m√≥n
        }
        
        localCartItemsContainer.innerHTML = cartHtml;
        localCartTotalAmount.textContent = totalAmount.toLocaleString('vi-VN') + ' VNƒê';
        localCartItemCountSpan.textContent = totalQuantity; // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n ti√™u ƒë·ªÅ
    }

    // =================================================================
    // H√ÄM X·ª¨ L√ù CLICK V√ÄO M√ìN ƒÇN (Th√™m v√†o LocalStorage)
    // =================================================================
    function addItemToLocalCart(itemData) {
        const username = getUsername();
        if (username === null) return;

        const cart = getLocalCart();
        const existingItem = cart.find(item => item.id === itemData.id);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...itemData, quantity: 1 });
        }
        saveLocalCart(cart);
        
        alert(`ƒê√£ th√™m "${itemData.name}" v√†o gi·ªè h√†ng t·∫°m th·ªùi.`);
    }

    // =================================================================
    // H√ÄM G·ª¨I L√äN API (COMMIT)
    // =================================================================
    async function sendLocalCartToAPI() {
        const username = getUsername();
        if (username === null) return;
        
        const localItems = getLocalCart();
        if (localItems.length === 0) {
            alert("Gi·ªè h√†ng tr·ªëng. Vui l√≤ng ch·ªçn m√≥n ƒÉn tr∆∞·ªõc.");
            return;
        }

        const apiItems = localItems.map(item => ({
            productId: item.id,
            quantity: item.quantity
        }));
        
        const postData = {
            username: username,
            items: apiItems
        };

        commitCartBtn.disabled = true;
        commitCartBtn.textContent = 'ƒêang g·ª≠i...';

        try {
            const response = await fetch(CART_ADD_API_URL, {
                method: 'POST',
                headers: {
                    'accept': '*/*',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`L·ªói t·ª´ Server: ${response.status} - ${errorText}`);
            }

            // Th√†nh c√¥ng: X√≥a Local Cart v√† c·∫≠p nh·∫≠t Navbar
            localStorage.removeItem(LOCAL_CART_KEY); // X√≥a Local Cart 
            renderLocalCartPanel(); // C·∫≠p nh·∫≠t giao di·ªán
            window.loadCartCount(username); 
            
            alert(`‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng ${apiItems.length} m√≥n v√†o Gi·ªè h√†ng ch√≠nh th·ª©c tr√™n server!`);

        } catch (error) {
            console.error('L·ªói khi th√™m v√†o gi·ªè h√†ng API:', error);
            alert(`‚ùå L·ªói: Kh√¥ng th·ªÉ g·ª≠i l√™n API. ${error.message}`);
            commitCartBtn.disabled = false;
        } finally {
             commitCartBtn.textContent = '‚úÖ Th√™m v√†o Gi·ªè h√†ng (G·ª≠i API)';
        }
    }


    // =================================================================
    // LOGIC KH·ªûI T·∫†O V√Ä G·∫ÆN S·ª∞ KI·ªÜN
    // =================================================================

    document.addEventListener("DOMContentLoaded", function () {
        const menuContainer = document.getElementById('menu-container');
        const loggedInState = document.getElementById("user-logged-in-state");
        const loggedOutState = document.getElementById("user-logged-out-state");
        const displayNameSpan = document.getElementById("user-display-name");
        const avatarSpan = document.getElementById("user-avatar-initial"); 
        const cartLink = document.querySelector('a[href="@Url.Action("Index","Cart")"]'); 

        const username = localStorage.getItem("username"); 

        // --- Logic Navbar (Kh·ªüi t·∫°o UI) ---
        if (username) {
            if(displayNameSpan) displayNameSpan.textContent = username; 
            if(avatarSpan && username.length > 0) avatarSpan.textContent = username.charAt(0).toUpperCase();
            if(loggedInState) loggedInState.classList.remove("d-none"); ¬†
            if(loggedOutState) loggedOutState.classList.add("d-none"); 
            if(cartLink) cartLink.innerHTML = `üõí Gi·ªè (<span id="cartCount">0</span>)`;
        } else {
            if(loggedInState) loggedInState.classList.add("d-none"); ¬† 
            if(loggedOutState) loggedOutState.classList.remove("d-none"); 
            if(cartLink) cartLink.innerHTML = `üõí Gi·ªè`;
        }
        window.loadCartCount(username); 

        const logoutButton = document.getElementById("logout-button");
        if(logoutButton) {
            logoutButton.addEventListener("click", function (e) {
                e.preventDefault(); 
                localStorage.removeItem("username");
                localStorage.removeItem("jwtToken"); 
                localStorage.removeItem(LOCAL_CART_KEY); // X√≥a gi·ªè h√†ng local
                window.location.href = "@Url.Action("Login", "Account")";
            });
        }
        
        // --- G·∫Øn s·ª± ki·ªán cho n√∫t Commit (G·ª≠i API) ---
        commitCartBtn.addEventListener('click', sendLocalCartToAPI);
        
        // --- G·∫Øn s·ª± ki·ªán cho n√∫t X√≥a Gi·ªè h√†ng T·∫°m th·ªùi ---
        if(clearLocalCartBtn) {
            clearLocalCartBtn.addEventListener('click', clearLocalCart);
        }
        
        // --- L·∫Øng nghe s·ª± ki·ªán click chung (Cho c√°c n√∫t Th√™m v√† X√≥a Item) ---
        document.addEventListener('click', function(event) {
            const target = event.target;
            
            // X·ª≠ l√Ω n√∫t TH√äM V√ÄO GI·ªé
            if (target && target.classList.contains('add-to-cart-btn')) {
                const button = target;
                const itemData = {
                    id: parseInt(button.dataset.id),
                    name: button.dataset.name,
                    price: parseFloat(button.dataset.price)
                };
                addItemToLocalCart(itemData);
            } 
            
            // X·ª≠ l√Ω n√∫t X√ìA T·ª™NG S·∫¢N PH·∫®M
            else if (target && target.classList.contains('remove-item-btn')) {
                const itemId = parseInt(target.dataset.id);
                removeItemFromLocalCart(itemId);
            }
        });

        // --- T·∫£i danh s√°ch s·∫£n ph·∫©m (C√≥ l·ªçc isActive) ---
        fetch('https://localhost:7132/api/Menu')
            .then(response => {
                if (!response.ok) throw new Error('L·ªói k·∫øt n·ªëi API.');
                return response.json();
            })
            .then(data => {
                const activeItems = data.filter(item => item.isActive === true);
                menuContainer.innerHTML = '';
                let totalPrice = 0;
                
                activeItems.forEach(item => {
                    totalPrice += item.price;
                    
                    const dishCardHtml = `
                        <div class="col-12 col-md-6 col-lg-4 mb-4">
                            <div class="dish-card">
                                <img src="${item.imageUrl}" alt="${item.name}" class="dish-image"/>
                                <div class="body">
                                    <h5>${item.name} <span class="badge bg-light text-dark badge-price">${item.price.toLocaleString('vi-VN')} VNƒê</span></h5>
                                    <p>${item.description}</p>
                                    <div class="controls mt-2">
                                        <button type="button" class="btn btn-sm btn-success add-to-cart-btn" 
                                            data-id="${item.id}" 
                                            data-name="${item.name}" 
                                            data-price="${item.price}">
                                            üõí Th√™m v√†o gi·ªè
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    menuContainer.innerHTML += dishCardHtml;
                });
                const avgPrice = activeItems.length > 0 ? totalPrice / activeItems.length : 0;
                document.getElementById('avgPrice').innerText = avgPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i th·ª±c ƒë∆°n:', error);
                menuContainer.innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i th·ª±c ƒë∆°n. Vui l√≤ng ki·ªÉm tra l·∫°i API.</p>';
            });
            
        // --- Kh·ªüi t·∫°o hi·ªÉn th·ªã Local Cart ---
        renderLocalCartPanel();
    });
</script>