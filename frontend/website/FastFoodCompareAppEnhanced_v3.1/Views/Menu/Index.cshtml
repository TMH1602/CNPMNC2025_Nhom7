@{
    ViewData["Title"] = "Th·ª±c ƒë∆°n";
}

<style>
    /* CSS C·ª¶A B·∫†N (Gi·ªØ nguy√™n) */
    
    .user-avatar {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #ff6a00;
        color: #ffffff;
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* CSS CHO BACKGROUND V√Ä C·∫§U TR√öC C·ªòT */
    body {
        font-family: 'QuickSand', cursive, sans-serif;
        background-image: url('/images/BackGround1.jpg'); 
        background-size: cover;      
        background-repeat: no-repeat; 
        background-attachment: fixed; 
        background-position: center center;
    }
    .navbar {
    background-color: #ffffff !important; 
    
    /* === C·ªë ƒë·ªãnh tr√™n c√πng v√† lu√¥n thu g·ªçn === */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1040; /* Cao h∆°n thanh danh m·ª•c (1030) */

    /* Ki·ªÉu d√°ng thu g·ªçn (V√≠ d·ª•: Chi·ªÅu cao 60px) */
    height: 60px; 
    padding: 10px 0; /* Gi·∫£m padding */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Th√™m b√≥ng ƒë·ªï nh·∫π */
    
    /* Th√™m transition ƒë·ªÉ ƒë·∫£m b·∫£o c√°c thay ƒë·ªïi n·∫øu c√≥ sau n√†y s·∫Ω m∆∞·ª£t m√† */
    transition: all 0.5s ease-in-out; 
}
    
    /* C·∫•u tr√∫c 2 c·ªôt */
    .container-fluid {
        padding-left: 0;
        padding-right: 0;
    }
    .page-content-wrapper {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    /* C·ªôt Tr√°i (Main Content) */
    .col-left-panel {
        background-color: rgba(255, 255, 255, 0.95);
        margin-right: 10px; /* Kho·∫£ng c√°ch 10px gi·ªØa 2 c·ªôt */
        border-radius: 12px; 
        width: 1200px;
        margin-left: 30px;
        padding: 30px;
        margin-bottom:100px;
    }
    
    /* C·ªôt Ph·∫£i (Local Cart) - FIXED BOTTOM */
    .col-right-panel {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px 12px 12px 12px; 
        padding: 20px;
        position: fixed;
        top: unset; 
        bottom: 150px;
        right: 20px; /* ƒê·∫∑t s√°t l·ªÅ ph·∫£i */
        width: 350px; /* K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh (kho·∫£ng 3-4 c·ªôt) */
        max-height: calc(250vh - 250px); /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao t·ªëi ƒëa */
        box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung qu√° d√†i */
        z-index: 1000; /* ƒê·∫£m b·∫£o n·∫±m tr√™n c√°c n·ªôi dung kh√°c */
    }

    /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ c·ªôt tr√°i ƒë·ªÉ kh√¥ng b·ªã c·ªôt ph·∫£i ƒë√® l√™n */
    .col-left-panel-wrapper {
        margin-right: 500px; 
        min-height: 250vh; 
    }

    #local-cart-items-container {
        padding-right: 5px; 
    }
    
    /* CSS cho n√∫t x√≥a item */
    .remove-item-btn {
        background: none;
        border: none;
        color: #dc3545; /* M√†u ƒë·ªè */
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0 5px;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .remove-item-btn:hover {
        opacity: 1;
        text-decoration: underline;
    }
    
    /* CSS cho c√°c n√∫t Category m·ªõi */
    .category-btn {
        margin-right: 8px;
        margin-bottom: 8px;
        border-radius: 50px;
        border: 1px solid #ff6a00;
        color: #ff6a00;
        background-color: #fff;
        padding: 6px 15px;
        font-weight: 500;
        transition: all 0.2s;
        white-space: nowrap; 
    }
    .category-btn:hover:not(.active) {
        background-color: #fff0e0;
        transform: translateY(-2px); /* N√¢ng l√™n 2px */
        box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* B√≥ng ƒë·ªï m·∫°nh h∆°n khi hover */
    }
    .category-btn.active {
        border-color: black;
        background-color: #ff6a00;
        color: #ffffff;
        transform: translateY(-5px);
        box-shadow: 0 20px 20px rgba(0,0,0,0.1);
    }
    .footer-wrapper-white { 
    background-color: #dbcb9c; 
    border-radius: 12px; 
    padding: 15px; 
    /* ƒê√É LO·∫†I B·ªé bottom: 0; */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
    text-align: left;
    width: 100%; 
    
    /* üéØ THAY ƒê·ªîI T·∫†I ƒê√ÇY: Lo·∫°i b·ªè position: absolute/fixed. 
       Footer s·∫Ω n·∫±m trong lu·ªìng t√†i li·ªáu (position: static/m·∫∑c ƒë·ªãnh) */
    /* ƒê·∫£m b·∫£o n√≥ kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi c√°c thu·ªôc t√≠nh v·ªã tr√≠ c≈© */
    position: static; 
    z-index: 0; 

    /* Th√™m margin-top ho·∫∑c padding-top n·∫øu b·∫°n mu·ªën footer c√°ch xa n·ªôi dung ch√≠nh m·ªôt ch√∫t */
    margin-top: 30px; 
}
    /* KH·ªêI CH·ª®A C√ÅC N√öT CATEGORY */
    #full-width-category-container {
        background-color: rgba(255, 255, 255, 0.95);
        margin-top:50px;
        padding: 15px 30px 10px 30px; 
        border-radius: 12px;
        margin-left: 10px;
        margin-right: 10px;
        text-align: center;
        transition: all 0.6s ease;
    }
    #full-width-category-container h2 {
        margin-top: 0;
        margin-bottom: 10px;
    }
    .is-fixed {
    /* C·ªë ƒë·ªãnh v·ªã tr√≠ */
        position: fixed;
        top: 30px; /* C·ªë ƒë·ªãnh s√°t m√©p tr√™n */
        right: 30px; /* C·ªë ƒë·ªãnh s√°t m√©p tr√°i */
        z-index: 1030; /* ƒê·∫£m b·∫£o n√≥ n·∫±m tr√™n c√°c n·ªôi dung kh√°c */
        
        /* Thay ƒë·ªïi k√≠ch th∆∞·ªõc v√† ki·ªÉu d√°ng ƒë·ªÉ nh·ªè g·ªçn h∆°n */
        width: auto; /* Chi·ªÅu r·ªông t·ª± ƒë·ªông (ho·∫∑c ƒë·∫∑t gi√° tr·ªã nh·ªè h∆°n n·∫øu mu·ªën) */
        max-width: 300px; /* V√≠ d·ª•: Gi·ªõi h·∫°n chi·ªÅu r·ªông nh·ªè h∆°n */
        
        /* Gi·∫£m padding ƒë·ªÉ nh·ªè g·ªçn h∆°n */
        padding: 10px 15px; 
        
        /* X√≥a margin ƒë√£ ƒë·∫∑t ban ƒë·∫ßu */
        margin: 0; 
        
        /* Bo g√≥c ch·ªâ ·ªü b√™n ph·∫£i ƒë·ªÉ tr√¥ng nh∆∞ thanh sidebar nh·ªè */
        border-radius: 12px 0 0 12px;
        text-align: right; /* CƒÉn l·ªÅ tr√°i khi c·ªë ƒë·ªãnh */
    }

</style>


<div class="container-fluid page-content-wrapper">
    
    <div id="full-width-category-container" class="mb-4">
         <h1>Th·ª±c ƒë∆°n</h1>
        <div id="category-filter-container" class="d-flex flex-wrap">
            </div>
    </div>
    <div class="row g-0 justify-content-between">
        
        <div class="col-left-panel col-left-panel-wrapper">
            <div class="mb-3">
                <img src="/images/banner.jpg" onerror="this.src='/images/placeholder-ad.jpg'" class="w-100 ad-banner" alt="Ad banner" />
            </div>

            <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
                <span class="me-3"><strong>Gi√° trung b√¨nh:</strong> <span id="avgPrice">ƒêang t√≠nh...</span></span>
            </div>

            <div id="menu-container" class="row">
                <p>ƒêang t·∫£i th·ª±c ƒë∆°n, vui l√≤ng ch·ªù...</p>
            </div>
        </div>

        <div class="col-right-panel">
            
            <h5 class="mb-3 text-center">üõí C√°c m√≥n ƒë√£ ch·ªçn <span class="badge bg-danger rounded-pill" id="local-cart-item-count">0</span></h5>

            <div id="local-cart-items-container" style="max-height: 250px; overflow-y: auto;">
                <p class="text-center text-muted">Ch∆∞a c√≥ m√≥n ƒÉn n√†o d·ª± ƒë·ªãnh th√™m v√†o gi·ªè</p>
            </div>
            
            <div id="cart-summary-total" class="mt-3 pt-3 border-top d-flex justify-content-between">
                <strong>T·ªïng c·ªông:</strong>
                <strong id="local-cart-total-amount">0 VNƒê</strong>
            </div>

            <div class="mt-3">
                <button id="clear-local-cart-btn" class="btn btn-outline-danger w-100 mb-2">
                    X√≥a t·∫•t c·∫£ m√≥n ƒÉn ƒë√£ ch·ªçn
                </button>
                
                <button id="commit-cart-btn" class="btn btn-success w-100 mb-2" disabled>
                    Th√™m V√†o gi·ªè h√†ng
                </button>
                <a href="@Url.Action("Index", "Cart")" class="btn btn-primary w-100">Xem Gi·ªè h√†ng ƒê√£ l∆∞u</a>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const LOCAL_CART_KEY = 'frontend_cart'; // Key cho gi·ªè h√†ng local
    const MENU_LOGIN_URL = 'Account/login'; 
    const CART_ADD_API_URL = 'https://localhost:7132/api/Cart/add';
    
    // Bi·∫øn l∆∞u tr·ªØ to√†n b·ªô d·ªØ li·ªáu menu ƒë√£ l·ªçc (isActive: true)
    let activeMenuItems = []; 
    // Bi·∫øn l∆∞u Category ƒëang ƒë∆∞·ª£c ch·ªçn
    let selectedCategory = 'T·∫•t c·∫£';

    // =================================================================
    // H√ÄM QU·∫¢N L√ù D·ªÆ LI·ªÜU CHUNG (NAVBAR)
    // =================================================================
    document.addEventListener('DOMContentLoaded', function() {
        const categoryContainer = document.getElementById('full-width-category-container');
        
        if (!categoryContainer) return; // Tho√°t n·∫øu kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠

        // L·∫•y v·ªã tr√≠ ban ƒë·∫ßu c·ªßa ph·∫ßn t·ª≠ so v·ªõi ƒë·ªânh trang
        // Offset Top l√† v·ªã tr√≠ m√† container b·∫Øt ƒë·∫ßu b·ªã cu·ªôn qua
        const stickyOffset = categoryContainer.offsetTop; 

        function handleScroll() {
            // Ki·ªÉm tra xem v·ªã tr√≠ cu·ªôn hi·ªán t·∫°i c√≥ l·ªõn h∆°n v·ªã tr√≠ ban ƒë·∫ßu c·ªßa container kh√¥ng
            if (window.scrollY > stickyOffset) {
                // Th√™m l·ªõp is-fixed khi cu·ªôn qua
                if (!categoryContainer.classList.contains('is-fixed')) {
                    categoryContainer.classList.add('is-fixed');
                }
            } else {
                // X√≥a l·ªõp is-fixed khi cu·ªôn ng∆∞·ª£c l·∫°i l√™n tr√™n
                if (categoryContainer.classList.contains('is-fixed')) {
                    categoryContainer.classList.remove('is-fixed');
                }
            }
        }

        // L·∫Øng nghe s·ª± ki·ªán cu·ªôn
        window.addEventListener('scroll', handleScroll);
        
        // G·ªçi h√†m m·ªôt l·∫ßn ƒë·ªÉ x·ª≠ l√Ω tr·∫°ng th√°i n·∫øu trang ƒë∆∞·ª£c t·∫£i ·ªü v·ªã tr√≠ ƒë√£ cu·ªôn
        handleScroll();
    });
    window.loadCartCount = async function (user) { /* ... (Gi·ªØ nguy√™n) ... */
        const cartCountSpan = document.getElementById("cartCount");
        if (!user || !cartCountSpan) return;

        const apiUrl = `https://localhost:7132/api/Cart/${user}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: { 'accept': 'text/plain' }
            });
            const cartData = await response.json();
            const totalItems = cartData.items ? 
                                         cartData.items.reduce((total, item) => total + (item.quantity || 0), 0) : 
                                         0;
            cartCountSpan.textContent = totalItems;
        } catch (error) {
            console.error('L·ªói t·∫£i gi·ªè h√†ng Navbar:', error);
            cartCountSpan.textContent = 0; 
        }
    }
    
    function getUsername() {
        const username = localStorage.getItem('username');
        if (!username) {
            alert("B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.");
            window.location.href = MENU_LOGIN_URL; 
            return null;
        }
        return username;
    }
    
    // =================================================================
    // H√ÄM QU·∫¢N L√ù LOCAL CART V√Ä RENDER
    // =================================================================
    const localCartItemsContainer = document.getElementById('local-cart-items-container');
    const localCartTotalAmount = document.getElementById('local-cart-total-amount');
    const commitCartBtn = document.getElementById('commit-cart-btn');
    const localCartItemCountSpan = document.getElementById('local-cart-item-count');
    const clearLocalCartBtn = document.getElementById('clear-local-cart-btn');

    function getLocalCart() { /* ... (Gi·ªØ nguy√™n) ... */
        const cartJson = localStorage.getItem(LOCAL_CART_KEY);
        return cartJson ? JSON.parse(cartJson) : [];
    }

    function saveLocalCart(cart) { /* ... (Gi·ªØ nguy√™n) ... */
        localStorage.setItem(LOCAL_CART_KEY, JSON.stringify(cart));
        renderLocalCartPanel(); // Lu√¥n render l·∫°i sau khi thay ƒë·ªïi
    }
    
    function clearLocalCart() { /* ... (Gi·ªØ nguy√™n) ... */
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ m√≥n ƒÉn trong gi·ªè h√†ng t·∫°m th·ªùi n√†y kh√¥ng?")) {
            localStorage.removeItem(LOCAL_CART_KEY);
            renderLocalCartPanel();
            alert("ƒê√£ x√≥a gi·ªè h√†ng t·∫°m th·ªùi.");
        }
    }
    
    function removeItemFromLocalCart(itemId) { /* ... (Gi·ªØ nguy√™n) ... */
        const cart = getLocalCart();
        const index = cart.findIndex(item => item.id === itemId);
        
        if (index > -1) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                alert(`ƒê√£ gi·∫£m s·ªë l∆∞·ª£ng c·ªßa m√≥n "${cart[index].name}".`);
            } else {
                const removedItemName = cart[index].name;
                cart.splice(index, 1);
                alert(`ƒê√£ x√≥a m√≥n "${removedItemName}" kh·ªèi gi·ªè h√†ng t·∫°m th·ªùi.`);
            }
        }
        
        saveLocalCart(cart);
    }


    function renderLocalCartPanel() { /* ... (Gi·ªØ nguy√™n) ... */
        const items = getLocalCart();
        let totalAmount = 0;
        let totalQuantity = 0;
        let cartHtml = '<ul class="list-unstyled">';

        if (items.length === 0) {
            cartHtml = '<p class="text-center text-muted">Ch∆∞a c√≥ m√≥n ƒÉn n√†o d·ª± ƒë·ªãnh th√™m v√†o gi·ªè</p>';
            commitCartBtn.disabled = true;
            if(clearLocalCartBtn) clearLocalCartBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t x√≥a khi tr·ªëng
        } else {
            items.forEach(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                totalAmount += itemTotal;
                totalQuantity += item.quantity;
                cartHtml += `
                    <li class="d-flex justify-content-between small mb-1">
                        <span>
                            ${item.name || 'S·∫£n ph·∫©m'} (x${item.quantity})
                            <button type="button" class="remove-item-btn" data-id="${item.id}">
                                (X√≥a)
                            </button>
                        </span>
                        <span class="fw-bold">${itemTotal.toLocaleString('vi-VN')} VNƒê</span>
                    </li>
                `;
            });
            cartHtml += '</ul>';
            commitCartBtn.disabled = false;
            if(clearLocalCartBtn) clearLocalCartBtn.disabled = false; // K√≠ch ho·∫°t n√∫t x√≥a khi c√≥ m√≥n
        }
        
        localCartItemsContainer.innerHTML = cartHtml;
        localCartTotalAmount.textContent = totalAmount.toLocaleString('vi-VN') + ' VNƒê';
        localCartItemCountSpan.textContent = totalQuantity; // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n ti√™u ƒë·ªÅ
    }

    // =================================================================
    // H√ÄM QU·∫¢N L√ù HI·ªÇN TH·ªä MENU V√Ä L·ªåC (M·ªöI)
    // =================================================================
    
    const menuContainer = document.getElementById('menu-container');
    const categoryContainer = document.getElementById('category-filter-container');

    /**
     * L·ªçc v√† render danh s√°ch m√≥n ƒÉn d·ª±a tr√™n Category ƒëang ch·ªçn.
     */
    function renderMenuItems(items) {
        let itemsToRender = items;
        if (selectedCategory && selectedCategory !== 'T·∫•t c·∫£') {
            itemsToRender = items.filter(item => item.category === selectedCategory);
        }

        menuContainer.innerHTML = '';
        let totalPrice = 0;
        
        if (itemsToRender.length === 0) {
            menuContainer.innerHTML = `<p class="text-muted p-3">Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o trong danh m·ª•c "${selectedCategory}".</p>`;
        }
        
        itemsToRender.forEach(item => {
            totalPrice += item.price;
            
            const dishCardHtml = `
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                    <div class="dish-card">
                        <img src="${item.imageUrl}" alt="${item.name}" class="dish-image"/>
                        <div class="body">
                            <h5>${item.name} <span class="badge bg-light text-dark badge-price">${item.price.toLocaleString('vi-VN')} VNƒê</span></h5>
                            <p>${item.description}</p>
                            <div class="controls mt-2">
                                <button type="button" class="btn btn-sm btn-success add-to-cart-btn" 
                                    data-id="${item.id}" 
                                    data-name="${item.name}" 
                                    data-price="${item.price}">
                                    üõí Th√™m v√†o gi·ªè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            menuContainer.innerHTML += dishCardHtml;
        });

        // T√≠nh gi√° trung b√¨nh
        const avgPrice = itemsToRender.length > 0 ? totalPrice / itemsToRender.length : 0;
        document.getElementById('avgPrice').innerText = avgPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }

    /**
     * Render c√°c n√∫t Category v√† g·∫Øn s·ª± ki·ªán l·ªçc.
     */
    function renderCategoryFilters(items) {
        // L·∫•y danh s√°ch Category duy nh·∫•t t·ª´ c√°c item ƒëang ho·∫°t ƒë·ªông
        const categories = [...new Set(items.map(item => item.category))].filter(c => c);
        
        // Th√™m n√∫t "T·∫•t c·∫£" l√™n ƒë·∫ßu
        categories.unshift('T·∫•t c·∫£');
        
        let categoryHtml = '';
        categories.forEach(category => {
            const isActive = category === selectedCategory ? 'active' : '';
            categoryHtml += `<button type="button" class="category-btn ${isActive}" data-category="${category}">${category}</button>`;
        });
        
        categoryContainer.innerHTML = categoryHtml;
    }
    
    /**
     * X·ª≠ l√Ω click v√†o n√∫t Category
     */
    function handleCategoryClick(event) {
        const target = event.target;
        if (target.classList.contains('category-btn')) {
            // C·∫≠p nh·∫≠t Category ƒëang ch·ªçn
            selectedCategory = target.dataset.category;
            
            // Render l·∫°i c·∫£ b·ªô l·ªçc v√† menu
            renderCategoryFilters(activeMenuItems);
            renderMenuItems(activeMenuItems);
        }
    }


    // =================================================================
    // H√ÄM X·ª¨ L√ù CLICK V√ÄO M√ìN ƒÇN (Th√™m v√†o LocalStorage)
    // =================================================================
    function addItemToLocalCart(itemData) {
        const username = getUsername();
        if (username === null) return;

        const cart = getLocalCart();
        const existingItem = cart.find(item => item.id === itemData.id);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...itemData, quantity: 1 });
        }
        saveLocalCart(cart);
        
        alert(`ƒê√£ th√™m "${itemData.name}" v√†o gi·ªè h√†ng t·∫°m th·ªùi.`);
    }

    // =================================================================
    // H√ÄM G·ª¨I L√äN API (COMMIT)
    // =================================================================
    async function sendLocalCartToAPI() {
        const username = getUsername();
        if (username === null) return;
        
        const localItems = getLocalCart();
        if (localItems.length === 0) {
            alert("Gi·ªè h√†ng tr·ªëng. Vui l√≤ng ch·ªçn m√≥n ƒÉn tr∆∞·ªõc.");
            return;
        }

        const apiItems = localItems.map(item => ({
            productId: item.id,
            quantity: item.quantity
        }));
        
        const postData = {
            username: username,
            items: apiItems
        };

        commitCartBtn.disabled = true;
        commitCartBtn.textContent = 'ƒêang g·ª≠i...';

        try {
            const response = await fetch(CART_ADD_API_URL, {
                method: 'POST',
                headers: {
                    'accept': '*/*',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`L·ªói t·ª´ Server: ${response.status} - ${errorText}`);
            }

            // Th√†nh c√¥ng: X√≥a Local Cart v√† c·∫≠p nh·∫≠t Navbar
            localStorage.removeItem(LOCAL_CART_KEY); // X√≥a Local Cart 
            renderLocalCartPanel(); // C·∫≠p nh·∫≠t giao di·ªán
            window.loadCartCount(username); 
            
            alert(`‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng ${apiItems.length} m√≥n v√†o Gi·ªè h√†ng ch√≠nh th·ª©c tr√™n server!`);

        } catch (error) {
            console.error('L·ªói khi th√™m v√†o gi·ªè h√†ng API:', error);
            alert(`‚ùå L·ªói: Kh√¥ng th·ªÉ g·ª≠i l√™n API. ${error.message}`);
            commitCartBtn.disabled = false;
        } finally {
             commitCartBtn.textContent = '‚úÖ Th√™m v√†o Gi·ªè h√†ng (G·ª≠i API)';
        }
    }


    // =================================================================
    // LOGIC KH·ªûI T·∫†O V√Ä G·∫ÆN S·ª∞ KI·ªÜN
    // =================================================================

    document.addEventListener("DOMContentLoaded", function () {
        const menuContainer = document.getElementById('menu-container');
        const loggedInState = document.getElementById("user-logged-in-state");
        const loggedOutState = document.getElementById("user-logged-out-state");
        const displayNameSpan = document.getElementById("user-display-name");
        const avatarSpan = document.getElementById("user-avatar-initial"); 
        const cartLink = document.querySelector('a[href="@Url.Action("Index","Cart")"]'); 

        const username = localStorage.getItem("username"); 

        // --- Logic Navbar (Kh·ªüi t·∫°o UI) ---
        if (username) {
            if(displayNameSpan) displayNameSpan.textContent = username; 
            if(avatarSpan && username.length > 0) avatarSpan.textContent = username.charAt(0).toUpperCase();
            if(loggedInState) loggedInState.classList.remove("d-none"); ¬†
            if(loggedOutState) loggedOutState.classList.add("d-none"); 
            if(cartLink) cartLink.innerHTML = `üõí Gi·ªè (<span id="cartCount">0</span>)`;
        } else {
            if(loggedInState) loggedInState.classList.add("d-none"); ¬† 
            if(loggedOutState) loggedOutState.classList.remove("d-none"); 
            if(cartLink) cartLink.innerHTML = `üõí Gi·ªè`;
        }
        window.loadCartCount(username); 

        const logoutButton = document.getElementById("logout-button");
        if(logoutButton) {
            logoutButton.addEventListener("click", function (e) {
                e.preventDefault(); 
                localStorage.removeItem("username");
                localStorage.removeItem("jwtToken"); 
                localStorage.removeItem(LOCAL_CART_KEY); // X√≥a gi·ªè h√†ng local
                window.location.href = "@Url.Action("Login", "Account")";
            });
        }
        
        // --- G·∫Øn s·ª± ki·ªán cho n√∫t Commit (G·ª≠i API) ---
        commitCartBtn.addEventListener('click', sendLocalCartToAPI);
        
        // --- G·∫Øn s·ª± ki·ªán cho n√∫t X√≥a Gi·ªè h√†ng T·∫°m th·ªùi ---
        if(clearLocalCartBtn) {
            clearLocalCartBtn.addEventListener('click', clearLocalCart);
        }
        
        // --- G·∫Øn s·ª± ki·ªán cho n√∫t Category (M·ªöI) ---
        categoryContainer.addEventListener('click', handleCategoryClick);
        
        // --- L·∫Øng nghe s·ª± ki·ªán click chung (Cho c√°c n√∫t Th√™m v√† X√≥a Item) ---
        document.addEventListener('click', function(event) {
            const target = event.target;
            
            // X·ª≠ l√Ω n√∫t TH√äM V√ÄO GI·ªé
            if (target && target.classList.contains('add-to-cart-btn')) {
                const button = target;
                const itemData = {
                    id: parseInt(button.dataset.id),
                    name: button.dataset.name,
                    price: parseFloat(button.dataset.price)
                };
                addItemToLocalCart(itemData);
            } 
            
            // X·ª≠ l√Ω n√∫t X√ìA T·ª™NG S·∫¢N PH·∫®M
            else if (target && target.classList.contains('remove-item-btn')) {
                const itemId = parseInt(target.dataset.id);
                removeItemFromLocalCart(itemId);
            }
        });

        // --- T·∫£i danh s√°ch s·∫£n ph·∫©m (C√≥ l·ªçc isActive) ---
        fetch('https://localhost:7132/api/Menu')
            .then(response => {
                if (!response.ok) throw new Error('L·ªói k·∫øt n·ªëi API.');
                return response.json();
            })
            .then(data => {
                // 1. L·ªçc v√† l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh
                activeMenuItems = data.filter(item => item.isActive === true);
                
                // 2. Render c√°c n√∫t Category
                renderCategoryFilters(activeMenuItems);
                
                // 3. Render to√†n b·ªô menu m·∫∑c ƒë·ªãnh
                renderMenuItems(activeMenuItems);
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i th·ª±c ƒë∆°n:', error);
                menuContainer.innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i th·ª±c ƒë∆°n. Vui l√≤ng ki·ªÉm tra l·∫°i API.</p>';
                document.getElementById('avgPrice').innerText = '0 VNƒê';
            });
            
        // --- Kh·ªüi t·∫°o hi·ªÉn th·ªã Local Cart ---
        renderLocalCartPanel();
    });
</script>