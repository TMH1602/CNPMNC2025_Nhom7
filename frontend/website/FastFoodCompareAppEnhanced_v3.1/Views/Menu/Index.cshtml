@{
    ViewData["Title"] = "Th·ª±c ƒë∆°n";
}

<h2 class="mb-3">Th·ª±c ƒë∆°n - M√≥n ƒÉn nhanh</h2>

<div class="mb-3">
    <img src="/images/banner.jpg" onerror="this.src='/images/placeholder-ad.jpg'" class="w-100 ad-banner" alt="Ad banner" />
</div>

<div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
    <span class="me-3"><strong>Gi√° trung b√¨nh:</strong> <span id="avgPrice">ƒêang t√≠nh...</span></span>
</div>

<div id="menu-container" class="row">
    <p>ƒêang t·∫£i th·ª±c ƒë∆°n, vui l√≤ng ch·ªù...</p>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const menuContainer = document.getElementById('menu-container');
        const cartCountSpan = document.getElementById('cartCount');

        // =================================================================
        // C√ÅC H√ÄM QU·∫¢N L√ù GI·ªé H√ÄNG B·∫∞NG LOCALSTORAGE
        // =================================================================
        function getCart() {
            const cartJson = localStorage.getItem('frontend_cart');
            return cartJson ? JSON.parse(cartJson) : [];
        }

        function saveCart(cart) {
            localStorage.setItem('frontend_cart', JSON.stringify(cart));
        }

        function updateCartIcon() {
            const cart = getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCountSpan) {
                cartCountSpan.innerText = totalItems;
            }
        }

        function addToCart(itemData) {
            const cart = getCart();
            const existingItem = cart.find(item => item.id === itemData.id);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...itemData, quantity: 1 });
            }
            saveCart(cart);
            updateCartIcon();
            alert(`ƒê√£ th√™m "${itemData.name}" v√†o gi·ªè h√†ng!`);
        }

        // =================================================================
        // LOGIC CH√çNH C·ª¶A TRANG
        // =================================================================

        // L·∫Øng nghe s·ª± ki·ªán click ƒë·ªÉ th√™m v√†o gi·ªè h√†ng
        document.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('add-to-cart-btn')) {
                const button = event.target;
                const itemData = {
                    id: parseInt(button.dataset.id),
                    name: button.dataset.name,
                    price: parseFloat(button.dataset.price)
                };
                addToCart(itemData);
            }
        });

        // T·∫£i danh s√°ch s·∫£n ph·∫©m t·ª´ API
        fetch('https://localhost:7132/api/Menu')
            .then(response => {
                if (!response.ok) throw new Error('L·ªói k·∫øt n·ªëi API.');
                return response.json();
            })
            .then(data => {
                menuContainer.innerHTML = '';
                let totalPrice = 0;
                data.forEach(item => {
                    totalPrice += item.price;
                    
                    // T·∫°o HTML cho m·ªói m√≥n ƒÉn (ƒë√£ b·ªè ph·∫ßn so s√°nh)
                    const dishCardHtml = `
                        <div class="col-12 col-md-6 col-lg-4 mb-4">
                            <div class="dish-card">
                                <img src="/images/placeholder.png" alt="${item.name}" class="dish-image"/>
                                <div class="body">
                                    <h5>${item.name} <span class="badge bg-light text-dark badge-price">${item.price.toLocaleString('vi-VN')} VNƒê</span></h5>
                                    <p>${item.description}</p>
                                    <div class="controls mt-2">
                                        <button type="button" class="btn btn-sm btn-success add-to-cart-btn" 
                                                data-id="${item.id}" 
                                                data-name="${item.name}" 
                                                data-price="${item.price}">
                                            üõí Th√™m v√†o gi·ªè
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    menuContainer.innerHTML += dishCardHtml;
                });
                const avgPrice = data.length > 0 ? totalPrice / data.length : 0;
                document.getElementById('avgPrice').innerText = avgPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i th·ª±c ƒë∆°n:', error);
                menuContainer.innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i th·ª±c ƒë∆°n. Vui l√≤ng ki·ªÉm tra l·∫°i API.</p>';
            });

        // C·∫≠p nh·∫≠t icon gi·ªè h√†ng khi t·∫£i trang
        updateCartIcon();
    });
</script>
}