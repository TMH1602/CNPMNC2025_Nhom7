@{
    ViewData["Title"] = "Gi·ªè h√†ng c·ªßa b·∫°n";
}

<h2 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<div id="cart-container">
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i gi·ªè h√†ng...</span>
        </div>
        <p class="mt-2">ƒêang t·∫£i gi·ªè h√†ng c·ªßa b·∫°n...</p>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cartContainer = document.getElementById('cart-container');
        const cartCountSpan = document.getElementById('cartCount'); 

        const username = localStorage.getItem('username');
        const token = localStorage.getItem('jwtToken');

        if (!username || !token) {
            cartContainer.innerHTML = '<div class="alert alert-danger">B·∫°n c·∫ßn <a href="@Url.Action("Login", "Account")">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem gi·ªè h√†ng.</div>';
            return;
        }

        const authHeader = {
            "accept": "text/plain" // S·ª≠a: Gi·ªè h√†ng n√™n l√† JSON
        };
        
        const apiUrl = `https://localhost:7132/api/Cart/${username}`; // L·∫•y username t·ª´ localStorage

        // === H√ÄM QU·∫¢N L√ù CACHE LOCALSTORAGE ===
        function getCartFromCache() {
            const cartJson = localStorage.getItem('frontend_cart_items'); // S·ª≠a key
            // Lu√¥n tr·∫£ v·ªÅ m·ªôt m·∫£ng
            try {
                const items = cartJson ? JSON.parse(cartJson) : [];
                return Array.isArray(items) ? items : []; 
            } catch (e) {
                return []; // N·∫øu JSON h·ªèng, tr·∫£ v·ªÅ m·∫£ng r·ªóng
            }
        }

        function saveCartToCache(items) {
             // ƒê·∫£m b·∫£o ch·ªâ l∆∞u m·∫£ng items
            if (Array.isArray(items)) {
                localStorage.setItem('frontend_cart_items', JSON.stringify(items));
            } else {
                 localStorage.setItem('frontend_cart_items', JSON.stringify([])); // L∆∞u m·∫£ng r·ªóng n·∫øu ƒë·∫ßu v√†o sai
            }
        }

        function updateCartIcon() {
            const items = getCartFromCache(); // L·∫•y t·ª´ cache
            const totalItems = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
            if (cartCountSpan) {
                cartCountSpan.innerText = totalItems;
            }
        }
        
        // === H√ÄM RENDER (ƒê√É S·ª¨A) ===
        function renderCart() {
            const items = getCartFromCache(); // L·∫•y m·∫£ng items t·ª´ cache

            if (!Array.isArray(items) || items.length === 0) {
                cartContainer.innerHTML = '<div class="alert alert-info">Gi·ªè h√†ng tr·ªëng.</div>';
                updateCartIcon(); // C·∫≠p nh·∫≠t icon v·ªÅ 0
                return;
            }

            let totalAmount = 0;
            let cartHtml = `
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>T√™n</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // D√πng forEach tr√™n m·∫£ng items
            items.forEach(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                totalAmount += itemTotal;
                cartHtml += `
                    <tr>
                        <td><img src="${item.imageUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" /></td>                        
                        <td>${item.productName}</td> 
                        
                        <td>${(item.price || 0).toLocaleString('vi-VN')} VNƒê</td>
                        <td>${item.quantity || 0}</td>
                        <td>${itemTotal.toLocaleString('vi-VN')} VNƒê</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-item-btn" data-product-id="${item.productId}">üóëÔ∏è X√≥a</button> 
                        </td>
                    </tr>
                `;
            });

            cartHtml += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-end"><strong>T·ªïng c·ªông:</strong></td>
                            <td colspan="1"><strong>${totalAmount.toLocaleString('vi-VN')} VNƒê</strong></td>
                        </tr>
                    </tfoot>
                </table>
                 <div class="text-end mt-3">
                    <button class="btn btn-danger" id="clear-cart-btn">X√≥a h·∫øt gi·ªè h√†ng</button>
                    <a href="@Url.Action("Index", "Checkout")" class="btn btn-primary">Ti·∫øn h√†nh thanh to√°n</a>
                 </div>
            `;
            cartContainer.innerHTML = cartHtml;
            updateCartIcon(); // C·∫≠p nh·∫≠t icon sau khi render
        }

        // === H√ÄM G·ªåI API (ƒê√É S·ª¨A) ===
        
        async function loadCartFromServer() {
            console.log("ƒêang t·∫£i gi·ªè h√†ng t·ª´:", apiUrl);
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: authHeader // ƒê√£ s·ª≠a accept th√†nh application/json
                });

                if (!response.ok) {
                    throw new Error(`L·ªói ${response.status}: Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng.`);
                }
                
                // API tr·∫£ v·ªÅ object { id, username, items: [] }
                const cartData = await response.json(); 
                
                console.log("API tr·∫£ v·ªÅ:", cartData);

                // S·ª≠a: Ch·ªâ l∆∞u m·∫£ng 'items' v√†o cache
                saveCartToCache(cartData.items || []); // L·∫•y m·∫£ng items, n·∫øu kh√¥ng c√≥ th√¨ d√πng m·∫£ng r·ªóng
                
                renderCart(); // Render t·ª´ cache ƒë√£ c·∫≠p nh·∫≠t

            } catch (error) {
                console.error("L·ªói fetch gi·ªè h√†ng:", error);
                cartContainer.innerHTML = `<div class="alert alert-danger">L·ªói khi t·∫£i gi·ªè h√†ng: ${error.message}</div>`;
                saveCartToCache([]); // X√≥a cache n·∫øu l·ªói
                renderCart(); // Render l·∫°i (s·∫Ω th·∫•y gi·ªè tr·ªëng)
            }
        }

        // H√†m x√≥a 1 m√≥n (C·∫ßn productId)
        async function removeItemFromServer(productId) {
            console.log("ƒêang x√≥a productId:", productId);
            try {
                // API n√†y l√† suy lu·∫≠n, b·∫°n c·∫ßn ki·ªÉm tra l·∫°i backend
                const deleteUrl = `${apiUrl}/items/${productId}`; // V√≠ d·ª• URL: /api/Cart/user2/items/17
                
                const response = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: authHeader
                });

                if (!response.ok) { 
                    const errorText = await response.text();
                    throw new Error(`X√≥a th·∫•t b·∫°i: ${errorText}`); 
                }

                // T·∫£i l·∫°i to√†n b·ªô gi·ªè h√†ng sau khi x√≥a th√†nh c√¥ng
                await loadCartFromServer(); 
                
            } catch (error) {
                console.error("L·ªói x√≥a item:", error);
                alert(`L·ªói khi x√≥a s·∫£n ph·∫©m: ${error.message}`);
            }
        }

        // H√†m x√≥a to√†n b·ªô gi·ªè h√†ng
        async function clearCartFromServer() {
            console.log("ƒêang x√≥a to√†n b·ªô gi·ªè h√†ng cho:", username);
            try {
                const response = await fetch(apiUrl, { // V√≠ d·ª• URL: DELETE /api/Cart/user2
                    method: 'DELETE',
                    headers: authHeader
                });
                
                if (!response.ok) { 
                     const errorText = await response.text();
                    throw new Error(`X√≥a th·∫•t b·∫°i: ${errorText}`); 
                }

                // T·∫£i l·∫°i gi·ªè h√†ng (s·∫Ω l√† r·ªóng)
                await loadCartFromServer();

            } catch (error) {
                 console.error("L·ªói x√≥a gi·ªè h√†ng:", error);
                alert(`L·ªói khi x√≥a gi·ªè h√†ng: ${error.message}`);
            }
        }

        // === G·∫ÆN S·ª∞ KI·ªÜN (ƒê√É S·ª¨A) ===
        cartContainer.addEventListener('click', async function(event) {
            
            // X√≥a 1 m√≥n
            if (event.target && event.target.classList.contains('remove-item-btn')) {
                // S·ª≠a: L·∫•y productId t·ª´ data attribute
                const productId = parseInt(event.target.dataset.productId); 
                if (!isNaN(productId) && confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                    await removeItemFromServer(productId); 
                }
            }
            
            // X√≥a h·∫øt
            if(event.target && event.target.id === 'clear-cart-btn') {
                if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                    await clearCartFromServer(); 
                }
            }
        });

        // === CH·∫†Y L·∫¶N ƒê·∫¶U ===
        loadCartFromServer();
    });
</script>
}