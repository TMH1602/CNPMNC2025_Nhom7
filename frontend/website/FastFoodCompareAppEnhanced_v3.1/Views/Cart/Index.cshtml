@{
    ViewData["Title"] = "Gi·ªè h√†ng c·ªßa b·∫°n";
}

<h2 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<div id="cart-container">
    </div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cartContainer = document.getElementById('cart-container');
        const cartCountSpan = document.getElementById('cartCount');

        // C√°c h√†m qu·∫£n l√Ω gi·ªè h√†ng (getCart, saveCart, updateCartIcon, removeItemFromCart)
        function getCart() {
            const cartJson = localStorage.getItem('frontend_cart');
            return cartJson ? JSON.parse(cartJson) : [];
        }

        function saveCart(cart) {
            localStorage.setItem('frontend_cart', JSON.stringify(cart));
        }

        function updateCartIcon() {
            const cart = getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCountSpan) {
                cartCountSpan.innerText = totalItems;
            }
        }
        
        function removeItemFromCart(itemId) {
            let cart = getCart();
            const newCart = cart.filter(item => item.id !== itemId);
            saveCart(newCart);
            renderCart();
            updateCartIcon();
        }

        // H√†m ƒë·ªÉ hi·ªÉn th·ªã gi·ªè h√†ng l√™n trang
        function renderCart() {
            const cart = getCart();

            if (cart.length === 0) {
                cartContainer.innerHTML = '<div class="alert alert-info">Gi·ªè h√†ng tr·ªëng. H√£y th√™m m√≥n ƒÉn t·ª´ menu!</div>';
                return;
            }

            let totalAmount = 0;
            let cartHtml = `
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>T√™n</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                totalAmount += itemTotal;
                cartHtml += `
                    <tr>
                        <td><img src="${item.imageUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" /></td>
                        <td>${item.name}</td>
                        <td>${item.price.toLocaleString('vi-VN')} VNƒê</td>
                        <td>${item.quantity}</td>
                        <td>${itemTotal.toLocaleString('vi-VN')} VNƒê</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-item-btn" data-id="${item.id}">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>
                `;
            });

            cartHtml += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-end"><strong>T·ªïng c·ªông:</strong></td>
                            <td colspan="1"><strong>${totalAmount.toLocaleString('vi-VN')} VNƒê</strong></td>
                        </tr>
                    </tfoot>
                </table>
                 <div class="text-end mt-3">
                    <button class="btn btn-danger" id="clear-cart-btn">X√≥a h·∫øt gi·ªè h√†ng</button>
                    <a href="@Url.Action("Index", "Checkout")" class="btn btn-primary">Ti·∫øn h√†nh thanh to√°n</a>
                </div>
            `;
            cartContainer.innerHTML = cartHtml;
        }

        // L·∫Øng nghe s·ª± ki·ªán click cho c√°c n√∫t x√≥a
        cartContainer.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('remove-item-btn')) {
                const itemId = parseInt(event.target.dataset.id);
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                    removeItemFromCart(itemId);
                }
            }
            if(event.target && event.target.id === 'clear-cart-btn') {
                if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                    saveCart([]);
                    renderCart();
                    updateCartIcon();
                }
            }
        });

        // Hi·ªÉn th·ªã gi·ªè h√†ng ngay khi t·∫£i trang
        renderCart();
    });
</script>
}