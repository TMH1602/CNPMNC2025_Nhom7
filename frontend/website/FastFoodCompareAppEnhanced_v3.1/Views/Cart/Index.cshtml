@{
    ViewData["Title"] = "Gi·ªè h√†ng c·ªßa b·∫°n";
}
<style>
    /* ... (To√†n b·ªô CSS c·ªßa b·∫°n ·ªü ƒë√¢y - kh√¥ng thay ƒë·ªïi) ... */
    .footer-wrapper-white { 
        background-color: #dbcb9c; 
        border-radius: 12px; 
        padding: 15px; 
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
        text-align: left;
        width: 100%; 
        bottom:0;
        position: static; 
        z-index: 0; 
        margin-top: 30px; 
    }
    .cart-table-centered th, 
    .cart-table-centered td {
        text-align: center;
    }
    .cart-table-centered td:first-child { 
        text-align: center; 
    }
    .btn-checkout-custom {
        color: #000 !important; 
        background-color: #ffc107; 
        border-color: #020202; 
        opacity: 0.9;
        font-weight: bold; 
        transition: opacity 0.2s; 
    }
    .btn-checkout-custom:hover {
        opacity: 1;
        background-color: #ffcd39; 
    }
    #cart-container {
        background-color: white; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
        margin-bottom: 200px;
    }
    .cart-header-wrapper {
        background-color: rgb(237, 235, 112); 
        padding: 15px 20px; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
        margin-bottom: 20px; 
        display: flex; 
        align-items: center;
        justify-content: center; 

    }
</style>

<div class="cart-header-wrapper">
    <h2 class="mb-0">üõí Gi·ªè h√†ng c·ªßa <span id="cart-username-display">b·∫°n</span></h2>
    </div>


<div id="cart-container">
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i gi·ªè h√†ng...</span>
        </div>
        <p class="mt-2">ƒêang t·∫£i gi·ªè h√†ng c·ªßa b·∫°n...</p>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cartContainer = document.getElementById('cart-container');
        const cartCountSpan = document.getElementById('cartCount'); 
        const cartUsernameDisplay = document.getElementById('cart-username-display');
        const username = localStorage.getItem('username');
        const token = localStorage.getItem('jwtToken'); // 1. L·∫•y token
        const LOGIN_URL = '@Url.Action("Login", "Account")';
        const API_BASE_URL = 'https://localhost:7132/api/Cart';
        
        // 2. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P TR∆Ø·ªöC
        if (!username || !token) {
            cartContainer.innerHTML = `<div class="alert alert-danger">B·∫°n c·∫ßn <a href="${LOGIN_URL}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem gi·ªè h√†ng.</div>`;
            return;
        }

        // 3. T·∫†O HEADER V·ªöI TOKEN
        const authHeader = {
            "accept": "application/json", 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}` // <-- S·ª¨A L·ªñI 401
        };
        // Header ri√™ng cho h√†m Remove (v√¨ n√≥ accept: */*)
        const authHeaderRemove = {
             "accept": "*/*",
             "Authorization": `Bearer ${token}` // <-- S·ª¨A L·ªñI 401
        };

        if (username && cartUsernameDisplay) {
            cartUsernameDisplay.textContent = username;
        }

        // 4. M√É H√ìA USERNAME ƒê·ªÇ TR√ÅNH L·ªñI K√ù T·ª∞ ƒê·∫∂C BI·ªÜT
        const encodedUsername = encodeURIComponent(username);
        const apiUrl = `${API_BASE_URL}/${encodedUsername}`; 

        // === H√ÄM QU·∫¢N L√ù CACHE LOCALSTORAGE ===
        function getCartFromCache() {
            // ... (Gi·ªØ nguy√™n)
            const cartJson = localStorage.getItem('frontend_cart_items'); 
            try {
                const items = cartJson ? JSON.parse(cartJson) : [];
                return Array.isArray(items) ? items : []; 
            } catch (e) {
                return []; 
            }
        }

        function saveCartToCache(items) {
            // ... (Gi·ªØ nguy√™n)
            if (Array.isArray(items)) {
                localStorage.setItem('frontend_cart_items', JSON.stringify(items));
            } else {
                localStorage.setItem('frontend_cart_items', JSON.stringify([])); 
            }
        }
        
        // H√†m c·∫≠p nh·∫≠t icon gi·ªè h√†ng tr√™n Navbar (g·ªçi h√†m loadCartCount t·ª´ _Layout)
        function refreshGlobalCartCount() {
            if (typeof window.loadCartCount === 'function') {
                // ƒê·∫£m b·∫£o h√†m loadCartCount c≈©ng ƒë∆∞·ª£c s·ª≠a ƒë·ªÉ g·ª≠i token
                window.loadCartCount(username); 
            }
        }
        
        // === H√ÄM RENDER GI·ªé H√ÄNG ===
        function renderCart() {
            // ... (H√†m n√†y gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi) ...
            const items = getCartFromCache();
            if (!Array.isArray(items) || items.length === 0) {
                cartContainer.innerHTML = '<div class="alert alert-info">Gi·ªè h√†ng tr·ªëng.</div>';
                refreshGlobalCartCount();
                return;
            }
            let totalAmount = 0;
            let cartHtml = `
                <table class="table table-bordered align-middle cart-table-centered">
                    <thead class="table-light">
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>T√™n</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                totalAmount += itemTotal;
                cartHtml += `
                    <tr>
                        <td><img src="${item.imageUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" /></td> 
                        <td>${item.productName}</td> 
                        
                        <td>${(item.price || 0).toLocaleString('vi-VN')} VNƒê</td>
                        <td>
                            <div class="d-flex align-items-center">
                                ${item.quantity || 0}
                            </div>
                        </td>
                        <td>${itemTotal.toLocaleString('vi-VN')} VNƒê</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-item-btn" 
                                    data-product-id="${item.productId}" 
                                    data-quantity="${item.quantity}">
                                üóëÔ∏è X√≥a
                            </button> 
                        </td>
                    </tr>
                `;
            });
            cartHtml += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-end"><strong>T·ªïng c·ªông:</strong></td>
                            <td colspan="1"><strong>${totalAmount.toLocaleString('vi-VN')} VNƒê</strong></td>
                        </tr>
                    </tfoot>
                </table>
                <div class="text-end mt-3">
                    <a href="@Url.Action("Index", "Checkout")" class="btn btn-checkout-custom">Ti·∫øn h√†nh thanh to√°n</a>
                </div>
            `;
            cartContainer.innerHTML = cartHtml;
            refreshGlobalCartCount(); 
        }

        // === H√ÄM G·ªåI API T·∫¢I GI·ªé H√ÄNG ===
        async function loadCartFromServer() {
             cartContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">ƒêang t·∫£i gi·ªè h√†ng...</span></div><p class="mt-2">ƒêang t·∫£i gi·ªè h√†ng c·ªßa b·∫°n...</p></div>';

            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: authHeader // <-- S·ª≠ d·ª•ng header ƒë√£ c√≥ token
                });

                if (!response.ok) {
                    // Th√™m x·ª≠ l√Ω l·ªói 401
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = LOGIN_URL;
                        return; // D·ª´ng h√†m
                    }
                    throw new Error(`L·ªói ${response.status}: Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng.`);
                }
                
                const cartData = await response.json(); 
                saveCartToCache(cartData.items || []); 
                renderCart(); 

            } catch (error) {
                console.error("L·ªói fetch gi·ªè h√†ng:", error);
                cartContainer.innerHTML = `<div class="alert alert-danger">L·ªói khi t·∫£i gi·ªè h√†ng: ${error.message}</div>`;
                saveCartToCache([]); 
                renderCart(); 
            }
        }

        // === H√ÄM X√ìA 1 M√ìN C√ì POP-UP NH·∫¨P S·ªê L∆Ø·ª¢NG ===
        async function removeItemWithPrompt(productId, maxQuantity) {
            
            const inputQuantity = prompt(`B·∫°n mu·ªën x√≥a bao nhi√™u s·∫£n ph·∫©m (t·ªëi ƒëa ${maxQuantity})?`, maxQuantity.toString());
            
            if (inputQuantity === null) {
                return; // Ng∆∞·ªùi d√πng nh·∫•n Cancel
            }

            let quantityToRemove = parseInt(inputQuantity);

            if (isNaN(quantityToRemove) || quantityToRemove <= 0) {
                alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë d∆∞∆°ng.");
                return;
            }

            if (quantityToRemove > maxQuantity) {
                alert(`B·∫°n ch·ªâ c√≥ th·ªÉ x√≥a t·ªëi ƒëa ${maxQuantity} s·∫£n ph·∫©m.`);
                quantityToRemove = maxQuantity; 
            }
            
            // S·ª≠ d·ª•ng username ƒë√£ m√£ h√≥a
            const removeUrl = `${API_BASE_URL}/remove?username=${encodedUsername}&productId=${productId}&quantity=${quantityToRemove}`;

            try {
                const response = await fetch(removeUrl, {
                    method: 'POST', 
                    headers: authHeaderRemove, // <-- S·ª≠ d·ª•ng header ƒë√£ c√≥ token
                    body: '' 
                });

                if (!response.ok) { 
                    // Th√™m x·ª≠ l√Ω l·ªói 401
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = LOGIN_URL;
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`X√≥a th·∫•t b·∫°i: ${errorText}`); 
                }
                
                alert(`ƒê√£ x√≥a ${quantityToRemove} s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng.`);
                await loadCartFromServer(); 
                
            } catch (error) {
                console.error("L·ªói x√≥a item:", error);
                alert(`L·ªói khi x√≥a s·∫£n ph·∫©m: ${error.message}`);
            }
        }

        // === H√ÄM X√ìA TO√ÄN B·ªò GI·ªé H√ÄNG ===
        async function clearCartFromServer() {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                try {
                    const response = await fetch(apiUrl, { // DELETE /api/Cart/{username}
                        method: 'DELETE',
                        headers: authHeader // <-- S·ª≠ d·ª•ng header ƒë√£ c√≥ token
                    });
                    
                    if (!response.ok) { 
                        // Th√™m x·ª≠ l√Ω l·ªói 401
                        if (response.status === 401) {
                            localStorage.clear();
                            window.location.href = LOGIN_URL;
                            return;
                        }
                         const errorText = await response.text();
                        throw new Error(`X√≥a th·∫•t b·∫°i: ${errorText}`); 
                    }

                    await loadCartFromServer();

                } catch (error) {
                    console.error("L·ªói x√≥a gi·ªè h√†ng:", error);
                    alert(`L·ªói khi x√≥a gi·ªè h√†ng: ${error.message}`);
                }
            }
        }

        // === G·∫ÆN S·ª∞ KI·ªÜN ===
        cartContainer.addEventListener('click', async function(event) {
            
            // X√≥a 1 m√≥n
            if (event.target && event.target.classList.contains('remove-item-btn')) {
                const button = event.target;
                const productId = parseInt(button.dataset.productId); 
                const maxQuantity = parseInt(button.dataset.quantity); 
                
                if (!isNaN(productId) && !isNaN(maxQuantity)) {
                    await removeItemWithPrompt(productId, maxQuantity); 
                }
            }
            
            // X√≥a h·∫øt (Ki·ªÉm tra xem b·∫°n c√≥ n√∫t 'clear-cart-btn' kh√¥ng, n·∫øu kh√¥ng c√≥ th√¨ th√¥i)
            if(event.target && event.target.id === 'clear-cart-btn') {
                await clearCartFromServer(); 
            }
        });

        // === CH·∫†Y L·∫¶N ƒê·∫¶U ===
        loadCartFromServer();
    });
</script>
}