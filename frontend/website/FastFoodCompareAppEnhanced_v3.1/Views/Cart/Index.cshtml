@{
    ViewData["Title"] = "Gi·ªè h√†ng c·ªßa b·∫°n";
}

<h2 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<div id="cart-container">
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i gi·ªè h√†ng...</span>
        </div>
        <p class="mt-2">ƒêang t·∫£i gi·ªè h√†ng c·ªßa b·∫°n...</p>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cartContainer = document.getElementById('cart-container');
        const cartCountSpan = document.getElementById('cartCount'); 

        const username = localStorage.getItem('username');
        const token = localStorage.getItem('jwtToken');
        const LOGIN_URL = '@Url.Action("Login", "Account")';
        const API_BASE_URL = 'https://localhost:7132/api/Cart';
        
        const authHeader = {
            "accept": "application/json", 
            "Content-Type": "application/json"
        };
        
        const apiUrl = `${API_BASE_URL}/${username}`; 

        if (!username) {
            cartContainer.innerHTML = `<div class="alert alert-danger">B·∫°n c·∫ßn <a href="${LOGIN_URL}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem gi·ªè h√†ng.</div>`;
            return;
        }

        // === H√ÄM QU·∫¢N L√ù CACHE LOCALSTORAGE ===
        function getCartFromCache() {
            const cartJson = localStorage.getItem('frontend_cart_items'); 
            try {
                const items = cartJson ? JSON.parse(cartJson) : [];
                return Array.isArray(items) ? items : []; 
            } catch (e) {
                return []; 
            }
        }

        function saveCartToCache(items) {
            if (Array.isArray(items)) {
                localStorage.setItem('frontend_cart_items', JSON.stringify(items));
            } else {
                localStorage.setItem('frontend_cart_items', JSON.stringify([])); 
            }
        }
        
        // H√†m c·∫≠p nh·∫≠t icon gi·ªè h√†ng tr√™n Navbar (g·ªçi h√†m loadCartCount t·ª´ _Layout)
        function refreshGlobalCartCount() {
            if (typeof window.loadCartCount === 'function') {
                window.loadCartCount(username); 
            }
        }
        
        // === H√ÄM RENDER GI·ªé H√ÄNG ===
        function renderCart() {
            const items = getCartFromCache(); // L·∫•y m·∫£ng items t·ª´ cache

            if (!Array.isArray(items) || items.length === 0) {
                cartContainer.innerHTML = '<div class="alert alert-info">Gi·ªè h√†ng tr·ªëng.</div>';
                refreshGlobalCartCount();
                return;
            }

            let totalAmount = 0;
            let cartHtml = `
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>T√™n</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            items.forEach(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                totalAmount += itemTotal;
                cartHtml += `
                    <tr>
                        <td><img src="${item.imageUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" /></td> 
                        <td>${item.productName}</td> 
                        
                        <td>${(item.price || 0).toLocaleString('vi-VN')} VNƒê</td>
                        <td>
                            <div class="d-flex align-items-center">
                                ${item.quantity || 0}
                            </div>
                        </td>
                        <td>${itemTotal.toLocaleString('vi-VN')} VNƒê</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-item-btn" 
                                    data-product-id="${item.productId}" 
                                    data-quantity="${item.quantity}">
                                üóëÔ∏è X√≥a
                            </button> 
                        </td>
                    </tr>
                `;
            });

            cartHtml += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-end"><strong>T·ªïng c·ªông:</strong></td>
                            <td colspan="1"><strong>${totalAmount.toLocaleString('vi-VN')} VNƒê</strong></td>
                        </tr>
                    </tfoot>
                </table>
                <div class="text-end mt-3">
                    <button class="btn btn-danger" id="clear-cart-btn">X√≥a h·∫øt gi·ªè h√†ng</button>
                    <a href="@Url.Action("Index", "Checkout")" class="btn btn-primary">Ti·∫øn h√†nh thanh to√°n</a>
                </div>
            `;
            cartContainer.innerHTML = cartHtml;
            refreshGlobalCartCount(); 
        }

        // === H√ÄM G·ªåI API T·∫¢I GI·ªé H√ÄNG (GI·ªÆ NGUY√äN) ===
        async function loadCartFromServer() {
             cartContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">ƒêang t·∫£i gi·ªè h√†ng...</span></div><p class="mt-2">ƒêang t·∫£i gi·ªè h√†ng c·ªßa b·∫°n...</p></div>';

            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: authHeader
                });

                if (!response.ok) {
                    throw new Error(`L·ªói ${response.status}: Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng.`);
                }
                
                const cartData = await response.json(); 
                
                saveCartToCache(cartData.items || []); 
                
                renderCart(); 

            } catch (error) {
                console.error("L·ªói fetch gi·ªè h√†ng:", error);
                cartContainer.innerHTML = `<div class="alert alert-danger">L·ªói khi t·∫£i gi·ªè h√†ng: ${error.message}</div>`;
                saveCartToCache([]); 
                renderCart(); 
            }
        }

        // üéØ === H√ÄM X√ìA 1 M√ìN C√ì POP-UP NH·∫¨P S·ªê L∆Ø·ª¢NG ===
        async function removeItemWithPrompt(productId, maxQuantity) {
            
            // 1. Hi·ªÉn th·ªã pop-up cho ng∆∞·ªùi d√πng nh·∫≠p s·ªë l∆∞·ª£ng
            const inputQuantity = prompt(`B·∫°n mu·ªën x√≥a bao nhi√™u s·∫£n ph·∫©m (t·ªëi ƒëa ${maxQuantity})?`, maxQuantity.toString());
            
            if (inputQuantity === null) {
                return; // Ng∆∞·ªùi d√πng nh·∫•n Cancel
            }

            // 2. Ki·ªÉm tra v√† chuy·ªÉn ƒë·ªïi gi√° tr·ªã nh·∫≠p v√†o
            let quantityToRemove = parseInt(inputQuantity);

            if (isNaN(quantityToRemove) || quantityToRemove <= 0) {
                alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë d∆∞∆°ng.");
                return;
            }

            if (quantityToRemove > maxQuantity) {
                alert(`B·∫°n ch·ªâ c√≥ th·ªÉ x√≥a t·ªëi ƒëa ${maxQuantity} s·∫£n ph·∫©m.`);
                quantityToRemove = maxQuantity; // ƒê·∫∑t l·∫°i th√†nh t·ªëi ƒëa
            }
            
            // 3. G·ªçi API v·ªõi s·ªë l∆∞·ª£ng ƒë√£ nh·∫≠p/x√°c nh·∫≠n
            // X√¢y d·ª±ng URL theo format: /api/Cart/remove?username=string&productId=1&quantity=N
            const removeUrl = `${API_BASE_URL}/remove?username=${username}&productId=${productId}&quantity=${quantityToRemove}`;

            try {
                const response = await fetch(removeUrl, {
                    method: 'POST', 
                    headers: { "accept": "*/*" }, 
                    body: '' 
                });

                if (!response.ok) { 
                    const errorText = await response.text();
                    throw new Error(`X√≥a th·∫•t b·∫°i: ${errorText}`); 
                }
                
                alert(`ƒê√£ x√≥a ${quantityToRemove} s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng.`);
                // T·∫£i l·∫°i to√†n b·ªô gi·ªè h√†ng sau khi x√≥a th√†nh c√¥ng
                await loadCartFromServer(); 
                
            } catch (error) {
                console.error("L·ªói x√≥a item:", error);
                alert(`L·ªói khi x√≥a s·∫£n ph·∫©m: ${error.message}`);
            }
        }

        // === H√ÄM X√ìA TO√ÄN B·ªò GI·ªé H√ÄNG (GI·ªÆ NGUY√äN LOGIC DELETE) ===
        async function clearCartFromServer() {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                try {
                    const response = await fetch(apiUrl, { // DELETE /api/Cart/{username}
                        method: 'DELETE',
                        headers: authHeader
                    });
                    
                    if (!response.ok) { 
                         const errorText = await response.text();
                        throw new Error(`X√≥a th·∫•t b·∫°i: ${errorText}`); 
                    }

                    await loadCartFromServer();

                } catch (error) {
                    console.error("L·ªói x√≥a gi·ªè h√†ng:", error);
                    alert(`L·ªói khi x√≥a gi·ªè h√†ng: ${error.message}`);
                }
            }
        }

        // === G·∫ÆN S·ª∞ KI·ªÜN ===
        cartContainer.addEventListener('click', async function(event) {
            
            // X√≥a 1 m√≥n
            if (event.target && event.target.classList.contains('remove-item-btn')) {
                const button = event.target;
                const productId = parseInt(button.dataset.productId); 
                const maxQuantity = parseInt(button.dataset.quantity); // L·∫•y s·ªë l∆∞·ª£ng hi·ªán t·∫°i
                
                if (!isNaN(productId) && !isNaN(maxQuantity)) {
                    await removeItemWithPrompt(productId, maxQuantity); 
                }
            }
            
            // X√≥a h·∫øt
            if(event.target && event.target.id === 'clear-cart-btn') {
                await clearCartFromServer(); 
            }
        });

        // === CH·∫†Y L·∫¶N ƒê·∫¶U ===
        loadCartFromServer();
    });
</script>
}